  <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CyberAgro - xMango</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFFFFF">
  
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/app-mvp1/sw.js')
        .then(reg => { reg.update(); console.log('SW Registrado'); })
        .catch(err => console.log('SW Falhou:', err));
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* --- ESTILOS GERAIS --- */
    :root { font-family: system-ui, -apple-system, sans-serif; }
    body { margin: 0 0 80px 0; background: #FFFFFF; color: #333; height: 100vh; overflow-x: hidden; }
    .wrap { max-width: 640px; margin: 0 auto; padding: 16px; }
    .card { background: #F8F8F8; border: 1px solid #E0E0E0; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); margin-bottom: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    
    /* Bot√µes */
    button { background: #2a7bf6; color: white; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    button:active { transform: scale(0.98); }
    .btn-green { background: #28a745; width: 100%; font-size: 1.1rem; padding: 16px; margin-top: 10px; }
    .btn-outline { background: transparent; border: 1px solid #2a7bf6; color: #2a7bf6; width: 100%; margin-top: 10px; }
    .btn-danger { background: #fee; border: 1px solid #e33; color: #d32f2f; }

    /* Inputs */
    .area-input { width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 12px; margin-bottom: 10px; font-size: 1rem; box-sizing: border-box; }
    
    /* Utilit√°rios */
    .hide { display: none !important; }
    .muted { color: #555; font-size: 0.9rem; text-align: center; }
    .mono { font-family: monospace; color: #333; white-space: pre-wrap; }
    
    /* Login */
    .login-container { text-align: center; padding-top: 40px; }
    .login-error { color: #D32F2F; font-size: 0.9rem; margin-top: 10px; display: none; }
    
    /* Upload e Progresso */
    .btn-upload { position: relative; display: inline-block; background: #E6EEFA; color: #2a7bf6; border: 1px dashed #2a7bf6; width: 100%; text-align: center; padding: 20px; }
    .file-proxy { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .progress { height: 6px; background: #E0E0E0; border-radius: 999px; overflow: hidden; margin-top: 10px; }
    .bar { height: 100%; width: 0%; background: #28a745; transition: width .3s; }
    #previewVideo, #previewImage { width: 100%; border-radius: 12px; background: #000; margin-top: 10px; display: none; }

    /* Dashboard & Resumos */
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .summary-card { background: #EEE; border-radius: 16px; padding: 16px; text-align: center; }
    .summary-card label { font-size: 0.75rem; text-transform: uppercase; color: #666; display: block; margin-bottom: 5px; }
    .summary-card .value { font-size: 1.4rem; font-weight: bold; color: #28a745; }

    /* Cultura Grid */
    .cultura-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .cultura-btn { background: #FFF; border: 1px solid #EEE; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600; }
    .cultura-btn:hover { border-color: #28a745; color: #28a745; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .cultura-btn img { width: 40px; height: 40px; object-fit: contain; }

    /* Perfil */
    .profile-header { display: flex; align-items: center; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid #EEE; margin-bottom: 15px; }
    .profile-pic { width: 50px; height: 50px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; }
    .menu-item { display: flex; align-items: center; padding: 12px 0; color: #333; text-decoration: none; border-bottom: 1px solid #EEE; font-size: 1rem; cursor: pointer; }
    .menu-item.danger { color: #D32F2F; }

    /* Rodap√© e Chat (Mantidos) */
    .app-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #FFF; border-top: 1px solid #E0E0E0; display: none; justify-content: space-around; align-items: center; height: 60px; z-index: 999; }
    .footer-btn { flex: 1; text-align: center; font-size: 0.8rem; color: #888; padding: 10px; cursor: pointer; }
    .footer-btn.active { color: #28a745; font-weight: 600; }
    .footer-btn-central { background: #000; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; top: -15px; border: 4px solid #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .footer-btn-central img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .chat-fab { position: fixed; bottom: 80px; right: 20px; background: #28a745; width: 50px; height: 50px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; cursor: pointer; }
    .chat-fab img { width: 30px; height: 30px; }
    
    /* Chat Frame Styles (Mantidos do seu c√≥digo original, simplificados aqui para caber, mas funcionais) */
    .chat-frame-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f8f9fa; z-index: 2000; display: flex; flex-direction: column; }
    .chat-header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; display: flex; align-items: center; gap: 10px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .chat-input-container { padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee; }
    .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; }
    .chat-message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; }
    .chat-message.user { align-self: flex-end; background: #2a7bf6; color: white; }
    .chat-message.bot { align-self: flex-start; background: white; border: 1px solid #eee; }
  </style>
</head>
<body>

  <div id="login-screen" class="wrap login-container">
    <img src="logo.png?v=7" alt="Logo" width="120" style="margin-bottom: 20px;">
    <h2>Bem-vindo ao CyberAgro</h2>
    <p class="muted">Acesse sua conta para gerenciar suas contagens.</p>
    
    <div class="card" style="text-align: left; margin-top: 20px;">
      <label style="font-size: 0.9rem; font-weight: 600;">E-mail</label>
      <input type="email" id="emailInput" class="area-input" placeholder="seu@email.com">
      
      <label style="font-size: 0.9rem; font-weight: 600;">Senha</label>
      <input type="password" id="passInput" class="area-input" placeholder="******">
      
      <p id="loginError" class="login-error">Erro ao entrar.</p>
      
      <button id="btnLogin" class="btn-green">Entrar</button>
      <button id="btnRegister" class="btn-outline">Criar Conta Nova</button>
    </div>
  </div>

  <div id="selecao-cultura-screen" class="wrap hide">
    <h3 style="text-align: center; margin-top:40px;">O que vamos contar hoje?</h3>
    <div class="cultura-grid">
      <div id="btnManga" class="cultura-btn">
        <img src="manga.png" alt="Manga"><span>Manga</span>
      </div>
      <div class="cultura-btn" onclick="alert('Em breve!')">
        <img src="uva.png" alt="Uva"><span>Uva</span>
      </div>
      <div class="cultura-btn" onclick="alert('Em breve!')">
        <img src="pitaya.png" alt="Pitaya"><span>Pitaya</span>
      </div>
    </div>
  </div>

  <div id="dashboard-screen" class="wrap hide">
    <h3>Vis√£o Geral</h3>
    <div class="summary-grid">
      <div class="summary-card">
        <label>Total Mangas</label>
        <div class="value" id="dashTotalMangas">0</div>
      </div>
      <div class="summary-card">
        <label>Contagens</label>
        <div class="value" id="dashNumContagens">0</div>
      </div>
    </div>
    
    <h3>Hist√≥rico Recente</h3>
    <div id="historicoLista" style="display: flex; flex-direction: column; gap: 10px; padding-bottom: 60px;">
      <p class="muted">Carregando dados...</p>
    </div>
  </div>

  <div id="app-screen" class="wrap hide">
    <button onclick="window.nav('dashboard-screen')" style="background:#EEE; color:#333; margin-bottom:15px;">‚Üê Voltar</button>
    
    <div class="card">
      <h3>Nova Contagem</h3>
      <div class="row">
        <button class="btn-upload">
          üìÅ Escolher V√≠deo/Foto
          <input id="fileInput" class="file-proxy" type="file" accept="video/*,image/*">
        </button>
      </div>
      
      <input type="number" id="areaInput" class="area-input" placeholder="√Årea total (hectares)" style="margin-top:10px; display:none;">
      
      <div id="previewContainer">
        <video id="previewVideo" controls playsinline></video>
        <img id="previewImage">
      </div>
      
      <div style="margin-top: 15px;">
        <div class="progress"><div id="pbar" class="bar"></div></div>
        <p id="status" class="muted" style="margin-top: 5px;">Aguardando arquivo...</p>
      </div>
      
      <button id="btnSend" class="btn-green" disabled>Contar Mangas</button>
    </div>
    
    <div id="resultCard" class="card hide">
      <h3>Resultado da IA</h3>
      <pre id="resultText" class="mono" style="font-size: 1.2rem; font-weight: bold; color: #28a745;"></pre>
      <div id="detalhesExtras" class="mono" style="font-size: 0.9rem; margin-top: 10px;"></div>
      <button id="btnSalvar" class="btn-outline">üíæ Salvar no Hist√≥rico</button>
    </div>
  </div>

  <div id="perfil-screen" class="wrap hide">
    <div class="card">
      <div class="profile-header">
        <div class="profile-pic" id="profilePicInitials">U</div>
        <div>
          <div class="profile-name" id="profileEmail">Usuario</div>
          <div class="profile-subtitle">Produtor Rural</div>
        </div>
      </div>
      <div id="navSair" class="menu-item danger">
        <span style="margin-right: 10px;">üö™</span> Sair da Conta
      </div>
    </div>
  </div>

  <div id="chat-screen" class="chat-frame-container hide">
    <div class="chat-header">
      <button onclick="window.nav('dashboard-screen')" style="background:none; border:none; color:white; font-size:1.2rem;">‚Üê</button>
      <div style="flex: 1; font-weight:bold;">Assistente CyberAgro</div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message bot">Ol√°! Como posso ajudar na sua planta√ß√£o hoje?</div>
    </div>
    <div class="chat-input-container">
      <input type="text" id="chatInput" class="chat-input" placeholder="Digite sua mensagem...">
      <button id="chatSendBtn" class="chat-send-btn">‚Üí</button>
    </div>
  </div>

  <div class="app-footer">
    <a onclick="window.nav('dashboard-screen')" class="footer-btn">In√≠cio</a>
    <a onclick="window.nav('app-screen')" class="footer-btn-central"><img src="imagem1.jpeg" alt="+"></a>
    <a onclick="window.nav('perfil-screen')" class="footer-btn">Perfil</a>
  </div>

  <div id="btnChat" class="chat-fab" onclick="window.nav('chat-screen')">
    <img src="imagem2.png" alt="Chat">
  </div>

  <script type="module">
    // --- 1. CONFIGURA√á√ÉO DO FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // SUAS CHAVES DO PROJETO NOVO (cyberagro-90b43)
    const firebaseConfig = {
      apiKey: "AIzaSyAyIWfUq2XcM8NGtTY3WXi0Q5irRsJdkgc",
      authDomain: "cyberagro-90b43.firebaseapp.com",
      projectId: "cyberagro-90b43",
      storageBucket: "cyberagro-90b43.firebasestorage.app",
      messagingSenderId: "174960456565",
      appId: "1:174960456565:web:77fd9eb2bff33da20f993c"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Vari√°veis Globais de Estado
    let ultimaContagem = 0;
    let dadosExtras = "";

    // --- 2. SISTEMA DE LOGIN ---
    const emailInput = document.getElementById('emailInput');
    const passInput = document.getElementById('passInput');
    const loginError = document.getElementById('loginError');

    // Bot√£o ENTRAR
    document.getElementById('btnLogin').onclick = () => {
      const email = emailInput.value;
      const pass = passInput.value;
      if(!email || !pass) return alert("Preencha email e senha");
      
      document.getElementById('btnLogin').textContent = "Entrando...";
      signInWithEmailAndPassword(auth, email, pass)
        .catch((error) => {
          loginError.style.display = 'block';
          loginError.textContent = "Erro: " + error.message;
          document.getElementById('btnLogin').textContent = "Entrar";
        });
    };

    // Bot√£o CRIAR CONTA
    document.getElementById('btnRegister').onclick = () => {
      const email = emailInput.value;
      const pass = passInput.value;
      if(!email || !pass) return alert("Preencha email e senha para criar conta.");
      
      createUserWithEmailAndPassword(auth, email, pass)
        .then(() => alert("Conta criada! Voc√™ j√° est√° logado."))
        .catch((error) => alert("Erro ao criar: " + error.message));
    };

    // Bot√£o SAIR
    document.getElementById('navSair').onclick = () => {
      if(confirm("Deseja sair?")) signOut(auth);
    };

    // MONITOR DE AUTENTICA√á√ÉO (O "Porteiro")
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usu√°rio logou
        console.log("Logado como:", user.email);
        document.getElementById('profileEmail').textContent = user.email;
        document.getElementById('profilePicInitials').textContent = user.email[0].toUpperCase();
        
        // Esconde login e mostra app
        document.getElementById('login-screen').classList.add('hide');
        document.querySelector('.app-footer').style.display = 'flex';
        document.getElementById('btnChat').style.display = 'flex';
        
        // Carrega os dados DELE do banco
        carregarDadosDoUsuario(user.uid);
        
        nav('selecao-cultura-screen');
      } else {
        // Usu√°rio saiu
        window.nav('login-screen');
        document.querySelector('.app-footer').style.display = 'none';
        document.getElementById('btnChat').style.display = 'none';
      }
    });

    // --- 3. BANCO DE DADOS (FIRESTORE) ---
    function carregarDadosDoUsuario(uid) {
      // Ouve a pasta 'users/{uid}/contagens' em tempo real
      const q = query(collection(db, "users", uid, "contagens"), orderBy("data", "desc"));
      
      onSnapshot(q, (snapshot) => {
        let totalMangas = 0;
        let numContagens = 0;
        const lista = document.getElementById('historicoLista');
        lista.innerHTML = ""; // Limpa lista visual

        snapshot.forEach((doc) => {
          const dados = doc.data();
          totalMangas += dados.qtd;
          numContagens++;
          
          // Formata data
          let dataFormatada = "Data desconhecida";
          if (dados.data && dados.data.seconds) {
            dataFormatada = new Date(dados.data.seconds * 1000).toLocaleDateString('pt-BR');
          } else if (dados.data instanceof Date) {
            dataFormatada = dados.data.toLocaleDateString('pt-BR');
          }

          // Cria item na lista visual
          const item = document.createElement('div');
          item.className = 'card';
          item.style.marginBottom = '8px';
          item.style.padding = '12px';
          item.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong style="color:#333;">${dados.tipo || 'Manga'}</strong>
                <div style="font-size:0.8rem; color:#888;">${dataFormatada}</div>
              </div>
              <span style="color:#28a745; font-weight:bold; font-size:1.2rem;">${dados.qtd}</span>
            </div>
          `;
          lista.appendChild(item);
        });
        
        // Atualiza os resumos do dashboard
        document.getElementById('dashTotalMangas').textContent = totalMangas;
        document.getElementById('dashNumContagens').textContent = numContagens;
      });
    }

    async function salvarNoBanco(qtd, tipo, detalhes) {
      const user = auth.currentUser;
      if (!user) return alert("Erro: Usu√°rio n√£o logado.");
      
      try {
        await addDoc(collection(db, "users", user.uid, "contagens"), {
          qtd: parseInt(qtd),
          tipo: tipo,
          detalhes: detalhes || "",
          data: new Date()
        });
        alert("Salvo na nuvem com sucesso!");
        nav('dashboard-screen');
      } catch (e) {
        alert("Erro ao salvar: " + e.message);
        console.error(e);
      }
    }

    // --- 4. L√ìGICA DE CONTAGEM DA IA ---
    const fileInput = document.getElementById('fileInput');
    const btnSend = document.getElementById('btnSend');
    const status = document.getElementById('status');
    const resultCard = document.getElementById('resultCard');
    const M2_POR_HECTARE = 10000;
    const formatterInt = new Intl.NumberFormat('pt-BR', { style: 'decimal', maximumFractionDigits: 0 });
    const formatterCurrency = new Intl.NumberFormat('pt-BR', { style: 'decimal', minimumFractionDigits: 2 });

    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if(!file) return;
      
      status.textContent = "Arquivo: " + file.name;
      btnSend.disabled = false;
      
      const url = URL.createObjectURL(file);
      if(file.type.startsWith('video')) {
        document.getElementById('previewVideo').src = url;
        document.getElementById('previewVideo').style.display = 'block';
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('areaInput').style.display = 'block';
      } else {
        document.getElementById('previewImage').src = url;
        document.getElementById('previewImage').style.display = 'block';
        document.getElementById('previewVideo').style.display = 'none';
        document.getElementById('areaInput').style.display = 'none';
      }
    };

    btnSend.onclick = async () => {
      status.textContent = "Enviando para IA...";
      document.getElementById('pbar').style.width = '30%';
      
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("video", file);
      
      const API_URL = file.type.startsWith('video') 
         ? "https://contador-manga-476522137012.us-central1.run.app/contar"
         : "https://contador-manga-476522137012.us-central1.run.app/contar-imagem";

      try {
        const resp = await fetch(API_URL, { method: "POST", body: formData });
        const data = await resp.json();
        
        document.getElementById('pbar').style.width = '100%';
        status.textContent = "Conclu√≠do!";
        
        ultimaContagem = data.contagem_final || 0;
        
        // C√°lculos Agron√¥micos
        let htmlDetalhes = "";
        const area = parseFloat(document.getElementById('areaInput').value);
        
        if(file.type.startsWith('video') && area > 0) {
           const pesoMedio = 0.5; // 500g
           const precoKg = 1.86;  // Pre√ßo base
           
           const kg_m2 = (ultimaContagem * pesoMedio) / area;
           const kg_ha = Math.round(kg_m2 * M2_POR_HECTARE);
           const faturamento = kg_ha * precoKg;
           
           htmlDetalhes = `
             Estimativa: ${formatterInt.format(kg_ha)} KG/HA<br>
             Faturamento Est: R$ ${formatterCurrency.format(faturamento)}
           `;
        }
        
        dadosExtras = htmlDetalhes;
        
        document.getElementById('resultText').textContent = `${ultimaContagem} Mangas`;
        document.getElementById('detalhesExtras').innerHTML = htmlDetalhes;
        resultCard.classList.remove('hide');
        
      } catch (error) {
        status.textContent = "Erro na IA (Modo Demo)";
        // Fallback demo para voc√™ testar se a API estiver desligada
        ultimaContagem = Math.floor(Math.random() * 100) + 20;
        document.getElementById('resultText').textContent = `(Demo) ${ultimaContagem} Mangas`;
        resultCard.classList.remove('hide');
      }
    };

    document.getElementById('btnSalvar').onclick = () => {
      salvarNoBanco(ultimaContagem, 'Manga', dadosExtras);
    };

    // --- 5. L√ìGICA DE NAVEGA√á√ÉO E UTILS ---
    function nav(telaId) {
      ['login-screen', 'selecao-cultura-screen', 'dashboard-screen', 'app-screen', 'perfil-screen', 'chat-screen'].forEach(id => {
        document.getElementById(id).classList.add('hide');
      });
      document.getElementById(telaId).classList.remove('hide');
      
      // Controla visibilidade do rodap√©
      if (['login-screen', 'selecao-cultura-screen', 'chat-screen'].includes(telaId)) {
        document.querySelector('.app-footer').style.display = 'none';
        document.getElementById('btnChat').style.display = 'none';
      } else {
        document.querySelector('.app-footer').style.display = 'flex';
        document.getElementById('btnChat').style.display = 'flex';
      }
      
      // Chat especial display flex
      if(telaId === 'chat-screen') document.getElementById('chat-screen').style.display = 'flex';
    }

    document.getElementById('btnManga').onclick = () => nav('dashboard-screen');

    // Expondo fun√ß√µes para o HTML (Necess√°rio por causa do type="module")
    window.nav = nav;

    // --- 6. CHAT SIMPLES (N8N) ---
    // (C√≥digo simplificado para caber, usando fetch no webhook que voc√™ j√° tinha)
    const chatInput = document.getElementById('chatInput');
    const chatBtn = document.getElementById('chatSendBtn');
    const msgs = document.getElementById('chatMessages');
    
    chatBtn.onclick = async () => {
        const txt = chatInput.value;
        if(!txt) return;
        
        // Msg User
        const divUser = document.createElement('div');
        divUser.className = 'chat-message user';
        divUser.textContent = txt;
        msgs.appendChild(divUser);
        chatInput.value = "";
        
        // Envia N8N
        try {
            const req = await fetch("https://n8n-agent-476522137012.us-central1.run.app/webhook/chat", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: txt, chatId: "web_" + Date.now() })
            });
            const res = await req.json();
            const respostaBot = res.output || res.message || "Entendido.";
            
            const divBot = document.createElement('div');
            divBot.className = 'chat-message bot';
            divBot.innerHTML = marked.parse(respostaBot); // Usa Markdown
            msgs.appendChild(divBot);
            msgs.scrollTop = msgs.scrollHeight;
        } catch(e) {
            console.log(e);
        }
    };
  </script>
</body>
</html>
