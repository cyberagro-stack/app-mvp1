<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CyberAgro</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFFFFF">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/app-mvp1/sw.js')
        .then(reg => {
            reg.update();
            console.log('Service Worker Registrado v14');
        })
        .catch(err => console.log('Service Worker falhou:', err));
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- ESTILOS GERAIS --- */
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; }
    body { margin: 0 0 80px 0; background: #FFFFFF; color: #333333; height: 100vh; overflow-x: hidden; }
    .wrap { max-width: 640px; margin: 0 auto; padding: 16px; }
    .card { background: #F8F8F8; border: 1px solid #E0E0E0; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { background: #2a7bf6; color: white; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .muted { color: #555555; font-size: .9rem; text-align: center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; word-break: break-word; color: #333333; }
    h3 { margin-top: 20px; margin-bottom: 10px; }
    .btn-upload { position: relative; display: inline-block; background: #E6EEFA; color: #2a7bf6; border: 1px dashed #2a7bf6; }
    .file-proxy { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .area-input { font-family: inherit; font-size: 1rem; padding: 10px 14px; border: 1px solid #E0E0E0; border-radius: 12px; background: #FFFFFF; flex-grow: 1; min-width: 150px; }
    .progress { height: 6px; background: #E0E0E0; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #2a7bf6; transition: width .2s; }
    #previewVideo, #previewImage { width: 100%; border-radius: 12px; background: #000; margin-top: 10px; }
    .login-error { color: #D32F2F; font-size: 0.9rem; text-align: center; margin-top: 10px; display: none; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .summary-card { background: #EEEEEE; border: 1px solid #E0E0E0; border-radius: 16px; padding: 16px; }
    .summary-card label { display: block; font-size: 0.8rem; color: #555555; margin-bottom: 4px; text-transform: uppercase; }
    .summary-card .value { font-size: 1.25rem; font-weight: 600; color: #333; }
    .data-list { list-style: none; padding: 0; margin: 0; }
    .data-row { display: flex; justify-content: space-between; padding: 14px 8px; border-bottom: 1px solid #EEE; font-size: 0.9rem; }
    .data-row span:first-child { color: #333; }
    .data-row span:last-child { color: #555; font-weight: 500; }
    .btn-nova-contagem {
      background: #28a745; /* Verde */
      color: white;
      border: 0;
      border-radius: 12px;
      padding: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      font-size: 1.1rem;
      margin-top: 20px;
    }
    
    /* --- CHAT NATIVO PROFISSIONAL --- */
    .chat-frame-container {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        z-index: 2000; /* Z-Index alto para cobrir tudo */
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 18px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        position: relative;
    }
    
    .chat-back-btn { background: none; border: none; color: white; font-size: 1.5rem; width: auto; padding: 0 15px 0 5px; cursor: pointer; }
    
    .chat-header-title { flex: 1; font-size: 1.15rem; font-weight: 600; }
    .chat-header-status { font-size: 0.75rem; opacity: 0.9; }
    
    .chat-messages {
        flex: 1; overflow-y: auto; padding: 20px;
        display: flex; flex-direction: column; gap: 15px;
    }
    
    .chat-message {
        display: flex; gap: 10px; max-width: 85%; align-self: flex-start;
        animation: fadeIn 0.3s ease;
    }
    .chat-message.user { align-self: flex-end; flex-direction: row-reverse; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .chat-message-avatar {
        width: 35px; height: 35px; border-radius: 50%;
        background: white; padding: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        overflow: hidden; flex-shrink: 0;
    }
    .chat-message-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    
    /* Ajuste para o avatar do usu√°rio (sem imagem) */
    .chat-message.user .chat-message-avatar {
        background: #2a7bf6; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;
    }
    
    .chat-message-content {
        padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4;
        background: white; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border-top-left-radius: 2px;
    }
    .chat-message.user .chat-message-content {
        background: #dcf8c6; border-top-left-radius: 12px; border-top-right-radius: 2px;
    }
    
    .chat-input-container {
        background: white; padding: 15px; display: flex; gap: 10px; align-items: center;
        border-top: 1px solid #eee;
    }
    .chat-input {
        flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; background: #f9f9f9;
    }
    .chat-send-btn {
        width: 45px; height: 45px; border-radius: 50%; background: #28a745; color: white; border: none; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* --- RODAP√â E BOT√ïES --- */
    .app-footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #FFFFFF; border-top: 1px solid #E0E0E0;
      display: none; /* Come√ßa oculto */
      justify-content: space-around; align-items: center;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999;
      padding: 0 10px; height: 60px;
    }

    .chat-fab {
      position: fixed; bottom: 80px; right: 20px; background: #28a745;
      width: 55px; height: 55px; border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; 
      display: none; /* Come√ßa oculto */
      padding: 0; border: none; cursor: pointer;
    }
    .chat-fab img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

    .footer-btn { flex: 1; text-align: center; padding: 10px 5px; font-size: 0.8rem; text-decoration: none; color: #888; background: none; border: none; }
    .footer-btn.active { color: #28a745; font-weight: 600; }
    
    .footer-btn-central {
      background: #000; width: 60px; height: 60px;
      border-radius: 50%; position: relative; top: -20px;
      border: 4px solid #FFF; padding: 0; overflow: hidden;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.15);
    }
    .footer-btn-central img { width: 100%; height: 100%; object-fit: cover; }

    /* Helper */
    .hide { display: none !important; }
    
    /* Cultura e Perfil */
    .cultura-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .cultura-btn { background: #FFF; border: 1px solid #EEE; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .cultura-btn img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; }
    .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #eee; margin: 0 auto; display: block; }
    .menu-item { display: block; width: 100%; text-align: left; padding: 15px; border-bottom: 1px solid #eee; background: none; font-size: 1rem; }
  </style>
</head>
<body>

  <div id="login-screen" class="wrap">
    <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=9" height="200"></h1>
    <div class="card">
      <h3 style="text-align:center">Acesso Restrito</h3>
      <input type="password" id="inputSenha" placeholder="Senha de acesso">
      <button id="btnLogin">Entrar</button>
      <p id="msgErro" style="color:red; text-align:center; display:none; margin-top:10px;">Senha incorreta.</p>
    </div>
  </div>

  <div id="selecao-cultura-screen" class="wrap hide">
    <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=9" height="150"></h1>
    <div class="card">
      <h3 style="text-align: center;">Selecione a Cultura</h3>
      <div class="cultura-grid">
        <div id="btnIconeManga" class="cultura-btn"><img src="manga.png"><span>Manga</span></div>
        <div class="cultura-btn" onclick="alert('Em breve')"><img src="uva.png"><span>Uva</span></div>
        <div class="cultura-btn" onclick="alert('Em breve')"><img src="pitaya.png"><span>Pitaya</span></div>
      </div>
    </div>
  </div>

  <div id="dashboard-screen" class="wrap hide">
    <h3>Vis√£o Geral</h3>
    <div class="summary-grid">
      <div class="summary-card"><label>Contagens no Ano</label><div class="value">312</div></div>
      <div class="summary-card"><label>Est. Faturamento Anual</label><div class="value">R$ 13.4M</div></div>
    </div>
    <h3>Produtividade Mensal</h3>
    <ul class="data-list card">
      <li class="data-row"><span>Dezembro</span> <span>R$ 0,00</span></li>
      <li class="data-row"><span>Novembro</span> <span>R$ 0,00</span></li>
      <li class="data-row"><span>Janeiro</span> <span>R$ 0,00</span></li>
    </ul>
  </div>

  <div id="app-screen" class="wrap hide">
    <button onclick="nav('dashboard-screen')" style="background:#555; margin-bottom:15px;">VOLTAR AO INICIO</button>
    <div class="card">
      <div class="btn-upload" onclick="document.getElementById('fileInput').click()">
        üì∑ Escolher Arquivo
        <input type="file" id="fileInput" hidden accept="image/*,video/*">
      </div>
      <div style="text-align:center">
         <video id="previewVideo" controls style="width:100%; border-radius:12px; display:none; margin-top:10px;"></video>
         <img id="previewImage" style="width:100%; border-radius:12px; display:none; margin-top:10px;">
      </div>
      <input type="number" id="areaInput" placeholder="√Årea (m¬≤) se for v√≠deo" style="margin-top:10px;">
      <button id="btnEnviar" disabled>Enviar para IA</button>
      <p id="statusApp" style="text-align:center; margin-top:10px; font-family:monospace;"></p>
    </div>
  </div>

  <div id="resultado-screen" class="wrap hide">
    <button onclick="nav('dashboard-screen')" style="background:#555; margin-bottom:15px;">VOLTAR AO INICIO</button>
    <div class="card">
      <h3>Resultado Detalhado</h3>
      <pre id="txtResultado" style="background:#eee; padding:10px; border-radius:8px; overflow-x:auto; font-size:0.9rem;"></pre>
      <h3 style="margin-top:20px;">Gr√°fico Anual</h3>
      <canvas id="myChart" height="200"></canvas>
      <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <p id="txtPrevisao" style="font-size:0.9rem; font-weight:bold;"></p>
        <button id="btnAgenda" class="btn-nova-contagem" style="background:#f0ad4e; margin-top:10px;">Criar Lembrete</button>
      </div>
    </div>
  </div>
  
  <div id="chat-screen" class="chat-frame-container hide">
    <div class="chat-header">
      <button onclick="nav('dashboard-screen')" class="chat-back-btn">‚Üê</button>
      <img src="logo.png?v=9" style="width:35px; height:35px; border-radius:50%; background:white; padding:2px; object-fit:cover;">
      <div style="flex: 1;">
        <div class="chat-header-title">CyberAgro Assistente</div>
        <div class="chat-header-status">Online</div>
      </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message bot">
        <div class="chat-message-avatar">
            <img src="logo.png?v=9">
        </div>
        <div class="chat-message-content">Ol√°! Sou seu assistente virtual. Como posso ajud√°-lo hoje?</div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <input type="text" id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="chatSendBtn" class="chat-send-btn">‚Üí</button>
    </div>
  </div>
  
  <div id="perfil-screen" class="wrap hide">
    <div class="card" style="text-align:center;">
      <img src="logo.png?v=9" class="profile-pic">
      <h3>Wendell Nascoli</h3>
      <p style="color:#666;">uendeu.agro@gmail.com</p>
      <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
      <button class="menu-item" onclick="alert('Em obras')">üë§ Meus Dados</button>
      <button class="menu-item" style="color:red;" onclick="if(confirm('Sair?')) location.reload()">üö™ Sair</button>
    </div>
  </div>

  <div id="appFooter" class="app-footer">
    <a onclick="nav('dashboard-screen')" class="footer-btn active">In√≠cio</a>
    <a onclick="nav('resultado-screen')" class="footer-btn">Relat√≥rios</a>
    <a onclick="nav('app-screen')" class="footer-btn-central"><img src="imagem1.jpeg"></a>
    <a onclick="alert('Em breve')" class="footer-btn">Ranking</a> 
    <a onclick="nav('perfil-screen')" class="footer-btn">Perfil</a>
  </div>
  
  <button id="btnChatFab" class="chat-fab" onclick="nav('chat-screen')">
    <img src="imagem2.png">
  </button>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const SENHA_SECRETA = "cyberagro2025"; 
      const N8N_WEBHOOK_URL = "https://n8n-agent-476522137012.us-central1.run.app/webhook/agente-ia"; 
      
      // Telas
      const screens = {
        login: document.getElementById("login-screen"),
        cultura: document.getElementById("selecao-cultura-screen"),
        dashboard: document.getElementById("dashboard-screen"),
        app: document.getElementById("app-screen"),
        resultado: document.getElementById("resultado-screen"),
        chat: document.getElementById("chat-screen"),
        perfil: document.getElementById("perfil-screen")
      };

      const appFooter = document.getElementById("appFooter");
      const btnChatFab = document.getElementById("btnChatFab");

      // --- NAVEGA√á√ÉO CENTRAL ---
      window.nav = function(telaNome) {
        // Esconde todas
        Object.values(screens).forEach(el => el.classList.add('hide'));
        
        // Mostra a atual (mapeia nome curto para ID)
        const map = {
            'login-screen': screens.login,
            'selecao-cultura-screen': screens.cultura,
            'dashboard-screen': screens.dashboard,
            'app-screen': screens.app,
            'resultado-screen': screens.resultado,
            'chat-screen': screens.chat,
            'perfil-screen': screens.perfil
        };
        
        const tela = map[telaNome];
        if(tela) {
            tela.classList.remove('hide');
            // Chat usa flex, outros block
            tela.style.display = (telaNome === 'chat-screen') ? 'flex' : 'block';
        }

        // L√≥gica Footer/Fab
        if (['login-screen', 'selecao-cultura-screen', 'chat-screen'].includes(telaNome)) {
          appFooter.style.display = 'none';
          btnChatFab.style.display = 'none';
        } else {
          appFooter.style.display = 'flex';
          btnChatFab.style.display = 'block';
        }
      };
      
      // Inicializa
      window.nav('login-screen');

      // --- EVENTOS DE LOGIN ---
      document.getElementById('btnLogin').onclick = () => { 
          if (document.getElementById('inputSenha').value === SENHA_SECRETA) window.nav('selecao-cultura-screen'); 
          else document.getElementById('msgErro').style.display = 'block'; 
      };
      
      document.getElementById('btnIconeManga').onclick = () => window.nav('dashboard-screen');
      
      // --- CHATBOT ---
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      let isTyping = false;
      
      function formatTime() {
        const now = new Date();
        return now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      }
      
      function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'chat-message-avatar';
        
        if (!isUser) {
           // *** LOGO NO LUGAR DO ROB√î ***
           avatar.innerHTML = '<img src="logo.png?v=9">';
        } else {
           avatar.textContent = 'Voc√™';
        }

        const contentDiv = document.createElement('div');
        contentDiv.className = 'chat-message-content';
        contentDiv.innerHTML = text.replace(/\n/g, '<br>');
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showTypingIndicator() {
        if (isTyping) return;
        isTyping = true;
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message bot';
        typingDiv.id = 'typingIndicator';
        
        const avatar = document.createElement('div');
        avatar.className = 'chat-message-avatar';
        // *** LOGO NA ANIMA√á√ÉO ***
        avatar.innerHTML = '<img src="logo.png?v=9">';
        
        const indicator = document.createElement('div');
        indicator.className = 'chat-typing-indicator';
        indicator.innerHTML = '...'; // Simplificado
        
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(indicator);
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      function hideTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if(el) el.remove();
        isTyping = false;
      }
      
      async function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        addMessage(msg, true);
        chatInput.value = '';
        chatSendBtn.disabled = true;
        showTypingIndicator();
        
        try {
           // ID da sess√£o (simples)
           let chatId = localStorage.getItem('chatId') || 'chat_'+Date.now();
           localStorage.setItem('chatId', chatId);

           const res = await fetch(N8N_WEBHOOK_URL, {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ text: msg, chatId: chatId })
           });
           
           hideTypingIndicator();
           if(res.ok) {
             const json = await res.json();
             addMessage(json.response || json.output || "Sem resposta.");
           } else {
             addMessage("Erro no servidor.");
           }
        } catch(e) {
           hideTypingIndicator();
           addMessage("Erro de conex√£o.");
        }
        chatSendBtn.disabled = false;
      }
      
      chatSendBtn.onclick = sendMessage;
      chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
      
      // --- PREVIS√ÉO ---
      window.resetUI = function() {
        // (L√≥gica de reset mantida simples)
        document.getElementById('previewVideo').style.display='none';
        document.getElementById('previewImage').style.display='none';
        document.getElementById('statusApp').innerText='';
      }
      
      // --- INICIALIZA CHART (Placeholder) ---
      // (C√≥digo do gr√°fico mantido, s√≥ precisa ser chamado quando tiver dados)
    });
  </script>
</body>
</html>
