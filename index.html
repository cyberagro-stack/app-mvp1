<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CyberAgro</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFFFFF">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/app-mvp1/sw.js')
        .then(reg => { reg.update(); console.log('Service Worker v9'); })
        .catch(console.log);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ESTILOS BASE */
    :root { font-family: system-ui, -apple-system, sans-serif; }
    body { margin: 0 0 80px 0; background: #FFF; color: #333; height: 100vh; overflow-x: hidden; }
    .wrap { max-width: 640px; margin: 0 auto; padding: 16px; }
    .card { background: #F8F8F8; border: 1px solid #E0E0E0; border-radius: 16px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    
    /* BOTÃ•ES & INPUTS */
    button { background: #2a7bf6; color: white; border: 0; border-radius: 12px; padding: 12px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
    button:disabled { opacity: 0.6; }
    input { width: 100%; padding: 12px; border: 1px solid #DDD; border-radius: 12px; box-sizing: border-box; margin-bottom: 10px; }
    .btn-upload { display: block; background: #E6EEFA; color: #2a7bf6; border: 1px dashed #2a7bf6; text-align: center; padding: 20px; border-radius: 12px; margin-bottom: 10px; }

    /* SELEÃ‡ÃƒO DE CULTURA */
    .cultura-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .cultura-item { background: #FFF; border: 1px solid #EEE; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
    .cultura-item img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 5px; }
    .cultura-item span { font-size: 0.85rem; font-weight: 600; }

    /* FOOTER & CHAT FAB */
    .app-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #FFF; border-top: 1px solid #EEE; display: none; justify-content: space-around; align-items: center; height: 60px; z-index: 999; }
    .footer-btn { flex: 1; text-align: center; font-size: 0.8rem; color: #888; text-decoration: none; background: none; border: none; padding: 5px; }
    .footer-btn.active { color: #28a745; font-weight: bold; }
    
    .footer-btn-central { width: 60px; height: 60px; border-radius: 50%; background: #000; position: relative; top: -20px; border: 4px solid #FFF; overflow: hidden; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); padding: 0; }
    .footer-btn-central img { width: 100%; height: 100%; object-fit: cover; }

    .chat-fab { position: fixed; bottom: 80px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: #28a745; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; display: none; padding: 0; overflow: hidden; }
    .chat-fab img { width: 100%; height: 100%; object-fit: cover; }

    /* IFRAME DO CHAT (ESTILO NOVO) */
    .chat-iframe-container {
        position: fixed; top: 0; left: 0; right: 0; bottom: 60px; /* Deixa espaÃ§o pro footer */
        background: #FFF; z-index: 900;
    }
    iframe { border: none; width: 100%; height: 100%; }

    /* Helpers */
    .hide { display: none !important; }
    #previewVideo, #previewImage { width: 100%; border-radius: 12px; display: none; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="screen-login" class="wrap">
    <div style="text-align:center; margin-bottom:20px;"><img src="logo.png?v=9" height="200"></div>
    <div class="card">
      <h3 style="text-align:center">Acesso Restrito</h3>
      <input type="password" id="inputSenha" placeholder="Senha de acesso">
      <button id="btnLogin">Entrar</button>
      <p id="msgErro" style="color:red; text-align:center; display:none; margin-top:10px;">Senha incorreta.</p>
    </div>
  </div>

  <div id="screen-cultura" class="wrap hide">
    <div style="text-align:center; margin-bottom:20px;"><img src="logo.png?v=9" height="150"></div>
    <div class="card">
      <h3 style="text-align:center">Selecione a Cultura</h3>
      <div class="cultura-grid">
        <div class="cultura-item" id="btnManga"><img src="manga.png"><span>Manga</span></div>
        <div class="cultura-item" onclick="alert('Em breve')"><img src="uva.png"><span>Uva</span></div>
        <div class="cultura-item" onclick="alert('Em breve')"><img src="pitaya.png"><span>Pitaya</span></div>
      </div>
    </div>
  </div>

  <div id="screen-dashboard" class="wrap hide">
    <h3>VisÃ£o Geral</h3>
    <div class="card" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
      <div><small>Contagens</small><br><b>312</b></div>
      <div><small>Faturamento</small><br><b>R$ 13.4M</b></div>
    </div>
    <h3>HistÃ³rico</h3>
    <ul class="data-list card" style="padding:10px; list-style:none;">
      <li style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between;"><span>Dezembro</span> <span>R$ 0,00</span></li>
    </ul>
  </div>

  <div id="screen-app" class="wrap hide">
    <button onclick="nav('screen-dashboard')" style="background:#555; margin-bottom:15px;">VOLTAR</button>
    <div class="card">
      <div class="btn-upload" onclick="document.getElementById('fileInput').click()">
        ðŸ“· Escolher Arquivo
        <input type="file" id="fileInput" hidden accept="image/*,video/*">
      </div>
      <video id="previewVideo" controls></video>
      <img id="previewImage">
      <input type="number" id="areaInput" placeholder="Ãrea (mÂ²) se for vÃ­deo" style="margin-top:10px;">
      <button id="btnEnviar" disabled>Enviar para IA</button>
      <p id="statusApp" style="text-align:center; margin-top:10px; font-family:monospace;"></p>
    </div>
  </div>

  <div id="screen-resultado" class="wrap hide">
    <button onclick="nav('screen-dashboard')" style="background:#555; margin-bottom:15px;">VOLTAR</button>
    <div class="card">
      <h3>Resultado</h3>
      <pre id="txtResultado" style="background:#eee; padding:10px; border-radius:8px; overflow-x:auto;"></pre>
      <h3>GrÃ¡fico Anual</h3>
      <canvas id="myChart"></canvas>
      <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <p id="txtPrevisao" style="font-size:0.9rem;"></p>
        <button id="btnAgenda" style="background:#f0ad4e;">Criar Lembrete</button>
      </div>
    </div>
  </div>

  <div id="screen-chat" class="chat-iframe-container hide">
    <button onclick="nav('screen-dashboard')" style="position:absolute; top:10px; left:10px; z-index:999; background:#555; width:auto; padding:8px 12px;">VOLTAR</button>
    <iframe id="n8nFrame" src=""></iframe>
  </div>

  <div id="screen-perfil" class="wrap hide">
    <div class="card" style="text-align:center;">
      <img src="logo.png?v=9" width="80" style="border-radius:50%; background:#eee;">
      <h3>Wendell Nascoli</h3>
      <p>uendeu.agro@gmail.com</p>
      <hr>
      <button onclick="if(confirm('Sair?')) location.reload()" style="background:none; color:red; text-align:left;">ðŸšª Sair</button>
    </div>
  </div>

  <div id="appFooter" class="app-footer">
    <a onclick="nav('screen-dashboard')" class="footer-btn active">InÃ­cio</a>
    <a onclick="nav('screen-resultado')" class="footer-btn">RelatÃ³rios</a>
    <a onclick="nav('screen-app')" class="footer-btn-central"><img src="imagem1.jpeg"></a>
    <a onclick="alert('Em breve')" class="footer-btn">Ranking</a>
    <a onclick="nav('screen-perfil')" class="footer-btn">Perfil</a>
  </div>
  
  <button id="btnChatFab" class="chat-fab" onclick="nav('screen-chat')">
    <img src="imagem2.png">
  </button>

  <script>
    // --- CONFIGURAÃ‡Ã•ES ---
    const SENHA_MASTER = "cyberagro2025";
    // COLE AQUI A URL DO "CHAT TRIGGER" DO N8N (Modo ProduÃ§Ã£o):
    const N8N_CHAT_URL = "COLE_SUA_URL_DO_CHAT_TRIGGER_AQUI"; 
    // Ex: https://n8n-agent-xyz.run.app/chat/agente-ia

    // --- NAVEGAÃ‡ÃƒO CENTRAL ---
    function nav(telaId) {
      // Esconde todas as telas
      document.querySelectorAll('.wrap, .chat-iframe-container').forEach(el => el.classList.add('hide'));
      // Mostra a desejada
      document.getElementById(telaId).classList.remove('hide');
      
      // Controle do Footer/Fab
      const footer = document.getElementById('appFooter');
      const fab = document.getElementById('btnChatFab');
      
      if (['screen-login', 'screen-cultura'].includes(telaId)) {
        footer.style.display = 'none';
        fab.style.display = 'none';
      } else if (telaId === 'screen-chat') {
        // No chat, mostramos o iframe e escondemos o FAB, mas mantemos footer opcional
        footer.style.display = 'none'; 
        fab.style.display = 'none';
        // Carrega o chat se ainda nÃ£o carregou
        const iframe = document.getElementById('n8nFrame');
        if (!iframe.src) iframe.src = N8N_CHAT_URL;
      } else {
        footer.style.display = 'flex';
        fab.style.display = 'block';
      }
    }

    // --- LOGIN & FLUXO ---
    document.getElementById('btnLogin').onclick = () => {
      if (document.getElementById('inputSenha').value === SENHA_MASTER) nav('screen-cultura');
      else document.getElementById('msgErro').style.display = 'block';
    };
    document.getElementById('btnManga').onclick = () => nav('screen-dashboard');

    // --- APP CONTAGEM ---
    const fileInput = document.getElementById('fileInput');
    let selectedFile = null;

    fileInput.onchange = (e) => {
      selectedFile = e.target.files[0];
      if (!selectedFile) return;
      
      const isVideo = selectedFile.type.startsWith('video/');
      const vid = document.getElementById('previewVideo');
      const img = document.getElementById('previewImage');
      const url = URL.createObjectURL(selectedFile);
      
      if (isVideo) { vid.src = url; vid.style.display='block'; img.style.display='none'; }
      else { img.src = url; img.style.display='block'; vid.style.display='none'; }
      
      document.getElementById('btnEnviar').disabled = false;
    };

    document.getElementById('btnEnviar').onclick = async () => {
      const status = document.getElementById('statusApp');
      status.innerText = "Processando...";
      
      const form = new FormData();
      form.append('video', selectedFile);
      
      const isVideo = selectedFile.type.startsWith('video/');
      const apiUrl = isVideo 
        ? "https://contador-manga-476522137012.us-central1.run.app/contar"
        : "https://contador-manga-476522137012.us-central1.run.app/contar-imagem";

      try {
        // Pega preÃ§o
        let preco = 1.86;
        try {
           const r = await fetch(`mango_prices.json?v=${Date.now()}`);
           const j = await r.json();
           preco = j.preco_kg;
        } catch(e){}

        const res = await fetch(apiUrl, { method: 'POST', body: form });
        const data = await res.json();
        
        let txt = `CONTAGEM: ${data.contagem_final}\n`;
        let kg_ha = 0;

        if (isVideo) {
           const area = parseFloat(document.getElementById('areaInput').value) || 1;
           kg_ha = Math.round(((data.contagem_final * 0.5) / area) * 10000);
           const qtd_ha = Math.round((data.contagem_final / area) * 10000);
           txt += `QNTD/HA: ${qtd_ha.toLocaleString('pt-BR')}\n`;
           txt += `KG/HA: ${kg_ha.toLocaleString('pt-BR')}\n`;
           txt += `FATURAMENTO: R$ ${(kg_ha * preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        } else {
           txt += "Estimativa requer vÃ­deo.";
        }
        
        document.getElementById('txtResultado').innerText = txt;
        document.getElementById('txtPrevisao').innerText = `PreÃ§o Hoje: R$ ${preco}. PrevisÃ£o: R$ 2,50.`;
        
        // GrÃ¡fico
        new Chart(document.getElementById('myChart'), {
            type: 'line',
            data: {
                labels: ['3/10', '10/10', '17/10', '24/10', '31/10', '7/11'],
                datasets: [{ label: 'PreÃ§o (R$)', data: [2.51, 1.26, 1.95, 1.88, 2.06, 1.86], borderColor: 'green' }]
            }
        });
        
        // BotÃ£o Agenda
        document.getElementById('btnAgenda').onclick = () => {
            const url = new URL("https://calendar.google.com/calendar/render?action=TEMPLATE");
            url.searchParams.append('text', "Venda Manga");
            url.searchParams.append('details', txt);
            window.open(url.href, '_blank');
        };

        nav('screen-resultado');
        
      } catch (err) {
        status.innerText = "Erro: " + err.message;
      }
    };

    // Inicializa
    nav('screen-login');
  </script>
</body>
</html>
