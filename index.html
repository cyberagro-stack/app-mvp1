diff --git a/index.html b/index.html
index b6788927d323137377bee37297e5ef5455e749cb..ea2c3f311233c1a4794b327aeabf0b873cc6f2d2 100644
--- a/index.html
+++ b/index.html
@@ -431,60 +431,65 @@
       font-size: 0.8rem; font-weight: 600; text-align: center;
       box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer;
       display: flex; flex-direction: column; align-items: center; justify-content: center;
     }
     .cultura-btn:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
     .cultura-btn img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; }
     
     /* Estilos Perfil */
     .profile-header { display: flex; align-items: center; gap: 16px; }
     .profile-pic { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #DDD; }
     .profile-name { font-size: 1.2rem; font-weight: 600; color: #333; }
     .profile-subtitle { font-size: 0.9rem; color: #555; }
     .menu-list { margin-top: 20px; padding: 0; }
     .menu-item { display: flex; align-items: center; padding: 16px; text-decoration: none; color: #333; font-size: 1rem; border-bottom: 1px solid #EEE; }
     .menu-item:last-child { border-bottom: none; }
     .menu-item.danger { color: #D32F2F; } 
     .menu-icon { font-size: 1.2rem; margin-right: 16px; width: 24px; text-align: center; }
     .menu-chevron { margin-left: auto; color: #AAA; font-weight: 600; }
     
     /* Helper */
     .hide { display: none !important; }
   </style>
 </head>
 <body>
 
-  <div id="login-screen" class="wrap">
-    <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=7" alt="CyberAgro Logo" height="250"></h1>
-    <div class="card">
-      <h3 style="text-align: center;">Acesso Restrito</h3>
-      <p class="muted" style="text-align: left;">Insira a senha de acesso para continuar.</p>
-      <input type="password" id="passwordInput" placeholder="Senha" class="area-input" style="width:100%; box-sizing: border-box;">
-      <p id="loginError" class="login-error">Senha incorreta. Tente novamente.</p>
-      <button id="loginButton" style="width:100%; margin-top: 12px;">Entrar</button>
-    </div>
-  </div>
+  <div id="login-screen" class="wrap" style="text-align: center; padding-top: 40px;">
+    <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=7" alt="CyberAgro Logo" height="250"></h1>
+    <div class="card">
+      <h3 style="text-align: center;">Acesso CyberAgro</h3>
+      <p class="muted" style="text-align: left;">Entre ou crie sua conta para salvar o hist√≥rico.</p>
+      
+      <input type="email" id="emailInput" class="area-input" placeholder="seu@email.com" style="width:100%; box-sizing: border-box; margin-bottom:10px;">
+      <input type="password" id="passwordInput" placeholder="Senha" class="area-input" style="width:100%; box-sizing: border-box;">
+      
+      <p id="loginError" class="login-error">Erro ao entrar.</p>
+      
+      <button id="btnLogin" style="width:100%; margin-top: 12px;">Entrar</button>
+      <button id="btnRegister" style="width:100%; margin-top: 10px; background: transparent; border: 1px solid #2a7bf6; color: #2a7bf6;">Criar Nova Conta</button>
+    </div>
+  </div>
 
   <div id="selecao-cultura-screen" class="wrap hide">
     <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=7" alt="CyberAgro Logo" height="250"></h1>
     <div class="card">
       <h3 style="text-align: center;">Selecione a Cultura</h3>
       <div class="cultura-grid">
         <div id="btnIconeManga" class="cultura-btn">
           <img src="manga.png" alt="Manga"><span>Manga</span>
         </div>
         <div id="btnIconeUva" class="cultura-btn">
           <img src="uva.png" alt="Uva"><span>Uva</span>
         </div>
         <div id="btnIconePitaya" class="cultura-btn">
           <img src="pitaya.png" alt="Pitaya"><span>Pitaya</span>
         </div>
       </div>
     </div>
   </div>
 
   <div id="dashboard-screen" class="wrap hide">
     <h3>Vis√£o Geral</h3>
     <div class="summary-grid">
       <div class="summary-card"><label>Contagens no Ano</label><div class="value">312</div></div>
       <div class="summary-card"><label>Est. Faturamento Anual</label><div class="value">R$ 13.491.152</div></div>
     </div>
@@ -505,54 +510,57 @@
           <input id="fileInput" class="file-proxy" type="file" accept="video/*,image/*">
         </button>
         <input type="number" id="areaInput" placeholder="√Årea (m¬≤) (s√≥ p/ v√≠deo)" class="area-input" style="display:none;">
       </div>
       <div class="row" style="margin-top: 12px;">
          <button id="btnSend" disabled>2. Enviar para IA</button>
          <button id="btnClear" disabled style="background:#eee;color:#333;">Limpar</button>
       </div>
       <div style="margin:12px 0;text-align:left;">
         <div class="progress"><div id="pbar" class="bar"></div></div>
         <div style="margin-top:8px">Status: <span id="status" class="mono">aguardando ficheiro...</span></div>
         <div id="fileInfo" class="muted" style="text-align:left;margin-top:8px;">Nenhum ficheiro selecionado.</div>
         <video id="previewVideo" controls playsinline style="display:none;"></video>
         <img id="previewImage" src="" alt="Preview da Imagem" style="display:none;">
       </div>
       <div>
         <h3>Resultado</h3>
         <pre id="out" class="mono">‚Äî</pre>
       </div>
     </div>
   </div>
 
   <div id="resultado-screen" class="wrap hide">
     <button onclick="nav('dashboard-screen')" style="background:#555; margin-bottom:15px;">VOLTAR AO INICIO</button>
     <div class="card">
-      <h3>Resultado Detalhado</h3>
-      <pre id="resultado-detalhado" class="mono"></pre>
-      <h3 style="margin-top: 20px;">Gr√°fico Anual</h3>
-      <canvas id="myChart" height="200"></canvas> 
+      <h3>Resultado Detalhado</h3>
+      <pre id="resultado-detalhado" class="mono"></pre>
+      <button id="btnSalvarBanco" class="btn-nova-contagem" style="background:#2a7bf6; margin-top:10px;">
+        üíæ Salvar no Hist√≥rico Pessoal
+      </button>
+      <h3 style="margin-top: 20px;">Gr√°fico Anual</h3>
+      <canvas id="myChart" height="200"></canvas> 
       <div id="agenda-section" style="margin-top: 20px; border-top: 1px solid #E0E0E0; padding-top: 15px;">
         <h3 style="margin-top: 0;">Previs√£o de Venda</h3>
         <p id="forecast-message" class="mono" style="font-size: 0.9rem;"></p>
         <button id="btnAgenda" class="btn-nova-contagem" style="background-color: #f0ad4e; margin-top: 10px;">
           Deseja adicionar um lembrete na sua agenda?
         </button>
       </div>
     </div>
   </div>
   
   <div id="chat-screen" class="chat-frame-container hide">
     <div class="chat-header">
       <button onclick="nav('dashboard-screen')" class="chat-header-btn">‚Üê Voltar</button>
       <div style="flex: 1;">
         <div class="chat-header-title">CyberAgro Assistente</div>
         <div class="chat-header-status">Online</div>
       </div>
     </div>
     <div class="chat-messages" id="chatMessages">
       <div class="chat-empty-state">
         <div class="chat-empty-state-icon">üí¨</div>
         <div class="chat-empty-state-text">Ol√°! Sou seu assistente virtual. Como posso ajud√°-lo hoje?</div>
       </div>
     </div>
     <div class="chat-input-container">
@@ -566,510 +574,303 @@
       <img src="logo.png?v=7" alt="Foto de Perfil" class="profile-pic">
       <div class="profile-info">
         <div class="profile-name">CyberAgro</div>
         <div class="profile-subtitle">cyberagro.contato@gmail.com</div>
       </div>
     </div>
     <div class="menu-list card">
       <a href="#" class="menu-item" id="navMeusDados"><span class="menu-icon">üë§</span> <span>Meus Dados</span> <span class="menu-chevron">&gt;</span></a>
       <a href="#" class="menu-item" id="navConfig"><span class="menu-icon">‚öôÔ∏è</span> <span>Configura√ß√µes</span> <span class="menu-chevron">&gt;</span></a>
       <a href="#" class="menu-item danger" id="navSair"><span class="menu-icon">üö™</span> <span>Sair</span> <span class="menu-chevron">&gt;</span></a>
     </div>
   </div>
 
   <div class="app-footer">
     <a onclick="nav('dashboard-screen')" class="footer-btn active">In√≠cio</a>
     <a onclick="nav('resultado-screen')" class="footer-btn">Relat√≥rios</a>
     <a onclick="nav('app-screen')" class="footer-btn-central"><img src="imagem1.jpeg" alt="Nova"></a>
     <a onclick="alert('Em breve')" class="footer-btn">Irriga√ß√£o</a> 
     <a onclick="nav('perfil-screen')" class="footer-btn">Perfil</a>
   </div>
   
   <button id="btnChat" class="chat-fab" onclick="nav('chat-screen')">
     <img src="imagem2.png" alt="Chat">
   </button>
 
-  <script>
-    document.addEventListener("DOMContentLoaded", () => {
-      const SENHA_SECRETA = "cyberagro2025"; 
-      
-      // *** URL DO WEBHOOK DO N8N (PRODU√á√ÉO) ***
-      const N8N_CHAT_URL = "https://n8n-agent-476522137012.us-central1.run.app/webhook/chat"; 
-      
-      // Telas
-      const loginScreen = document.getElementById("login-screen");
-      const selecaoCulturaScreen = document.getElementById("selecao-cultura-screen");
-      const dashboardScreen = document.getElementById("dashboard-screen"); 
-      const appScreen = document.getElementById("app-screen");
-      const resultadoScreen = document.getElementById("resultado-screen");
-      const chatScreen = document.getElementById("chat-screen");
-      const perfilScreen = document.getElementById("perfil-screen");
-      
-      // Elementos UI
-      const appFooter = document.querySelector(".app-footer");
-      const btnChat = document.getElementById("btnChat");
-      const loginButton = document.getElementById("loginButton");
-      const passwordInput = document.getElementById("passwordInput");
-      const loginError = document.getElementById("loginError");
-      
-      // Bot√µes Sele√ß√£o
-      const btnIconeManga = document.getElementById("btnIconeManga");
-      const btnIconeUva = document.getElementById("btnIconeUva");
-      const btnIconePitaya = document.getElementById("btnIconePitaya");
-      
-      // Navega√ß√£o Centralizada
-      function nav(telaId) {
-        // Esconde todas as telas
-        const telas = [loginScreen, selecaoCulturaScreen, dashboardScreen, appScreen, resultadoScreen, chatScreen, perfilScreen];
-        telas.forEach(s => s.classList.add('hide'));
-        
-        // Mostra a tela desejada
-        const telaAtual = document.getElementById(telaId);
-        telaAtual.classList.remove('hide');
-        telaAtual.style.display = (telaId === 'chat-screen') ? 'flex' : 'block';
-        
-        // L√≥gica Rodap√©/Chat
-        if (telaId === 'login-screen' || telaId === 'selecao-cultura-screen') {
-          appFooter.style.display = 'none';
-          btnChat.style.display = 'none';
-        } else if (telaId === 'chat-screen') {
-           appFooter.style.display = 'none';
-           btnChat.style.display = 'none';
-           // Foca no input quando abre o chat
-           setTimeout(() => {
-             const chatInput = document.getElementById('chatInput');
-             if (chatInput) chatInput.focus();
-           }, 300);
-        } else {
-          appFooter.style.display = 'flex';
-          appFooter.style.pointerEvents = 'auto';
-          btnChat.style.display = 'block';
-          btnChat.style.pointerEvents = 'auto';
-        }
-      }
-      
-      // Inicializa√ß√£o
-      nav('login-screen');
-
-      // --- Eventos ---
-      loginButton.onclick = () => { 
-          if (passwordInput.value === SENHA_SECRETA) nav('selecao-cultura-screen'); 
-          else loginError.style.display = "block"; 
-      };
-      passwordInput.addEventListener("keypress", (e) => { if (e.key === "Enter") loginButton.click(); });
-
-      btnIconeManga.onclick = () => nav('dashboard-screen');
-      btnIconeUva.onclick = () => alert("Em breve!");
-      btnIconePitaya.onclick = () => alert("Em breve!");
-      
-      document.getElementById("navSair").onclick = (e) => { 
-        e.preventDefault(); 
-        if(confirm("Sair?")) window.location.reload(); 
-      };
-
-      // --- L√ìGICA DO APP DE CONTAGEM ---
-      const API_URL_VIDEO = "https://contador-manga-476522137012.us-central1.run.app/contar";
-      const API_URL_IMAGEM = "https://contador-manga-476522137012.us-central1.run.app/contar-imagem";
-      const M2_POR_HECTARE = 10000;
-      
-      const fileInput = document.getElementById("fileInput");
-      const areaInput = document.getElementById("areaInput"); 
-      const btnSend = document.getElementById("btnSend");
-      const btnClear = document.getElementById("btnClear");
-      const out = document.getElementById("out");
-      const statusEl = document.getElementById("status");
-      const pbar = document.getElementById("pbar");
-      const fileInfo = document.getElementById("fileInfo");
-      const previewVideo = document.getElementById("previewVideo");
-      const previewImage = document.getElementById("previewImage");
-      const resultadoDetalhado = document.getElementById("resultado-detalhado");
-      const forecastMessage = document.getElementById("forecast-message");
-      const btnAgenda = document.getElementById("btnAgenda");
-      let selectedFile = null;
-      let myChart = null; 
-
-      const formatterInt = new Intl.NumberFormat('pt-BR', { style: 'decimal', maximumFractionDigits: 0 });
-      const formatterCurrency = new Intl.NumberFormat('pt-BR', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 });
-
-      function renderChart(labels, dataPrices) {
-        const ctx = document.getElementById('myChart').getContext('2d');
-        if (myChart) myChart.destroy();
-        myChart = new Chart(ctx, {
-            type: 'line', 
-            data: { labels: labels, datasets: [{ label: 'Pre√ßo R$/KG (Tommy)', data: dataPrices, fill: true, borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', tension: 0.1 }] },
-            options: { responsive: true, maintainAspectRatio: true, scales: { y: { ticks: { callback: function(value) { return 'R$ ' + value.toFixed(2); } } } } }
-        });
-      }
-
-      function resetUI(){
-        selectedFile = null; fileInput.value = ""; areaInput.value = ""; 
-        btnSend.disabled = true; btnClear.disabled = true;
-        fileInfo.textContent = "Nenhum ficheiro selecionado.";
-        previewVideo.src = ""; previewVideo.style.display = "none";
-        previewImage.src = ""; previewImage.style.display = "none";
-        areaInput.style.display = "none"; 
-        out.innerHTML = "‚Äî"; pbar.style.width = "0%";
-        statusEl.textContent = "aguardando ficheiro...";
-      }
-
-      function checkInputs() {
-        const area = parseFloat(areaInput.value);
-        const isVideo = selectedFile && selectedFile.type.startsWith("video/");
-               const isImage = selectedFile && selectedFile.type.startsWith("image/");
-        if ((isVideo && area > 0) || isImage) {
-          btnSend.disabled = false; statusEl.textContent = "Pronto para enviar.";
-        } else {
-          btnSend.disabled = true;
-        }
-      }
-
-      fileInput.addEventListener("change", (e) => {
-        const file = e.target.files && e.target.files[0];
-        if (!file) return;
-        const isVideo = file.type.startsWith("video/");
-        const isImage = file.type.startsWith("image/");
-        if (!isVideo && !isImage) { alert("Erro: Apenas arquivos de V√çDEO ou IMAGEM s√£o permitidos."); resetUI(); return; }
-        selectedFile = file;
-        fileInfo.textContent = `${file.name} ‚Ä¢ ${(file.size/1024/1024).toFixed(2)} MB`;
-        btnClear.disabled = false;
-        const previewURL = URL.createObjectURL(file);
-        if (isVideo) {
-          previewVideo.src = previewURL; previewVideo.style.display = "block";
-          previewImage.style.display = "none"; areaInput.style.display = "block"; 
-          previewVideo.play().catch(()=>{});
-        } else {
-          previewImage.src = previewURL; previewImage.style.display = "block";
-          previewVideo.style.display = "none"; areaInput.style.display = "none"; 
-          areaInput.value = ""; checkInputs(); 
-        }
-      });
-      areaInput.addEventListener("input", checkInputs); 
-      btnClear.addEventListener("click", resetUI);
-
-      btnSend.addEventListener("click", async () => {
-        if (!selectedFile) return;
-        btnSend.disabled = true;
-        statusEl.textContent = "Obtendo cota√ß√£o...";
-        pbar.style.width = "10%";
-        let dados_preco;
-        try {
-          const respPreco = await fetch(`mango_prices.json?v=${Date.now()}`);
-          if (!respPreco.ok) throw new Error();
-          dados_preco = await respPreco.json();
-        } catch { dados_preco = { preco_kg: 1.86, peso_medio_g: 500 }; }
-
-        const isVideoRequest = selectedFile.type.startsWith("video/");
-        let target_url = isVideoRequest ? API_URL_VIDEO : API_URL_IMAGEM;
-        statusEl.textContent = "Enviando para IA...";
-        pbar.style.width = "30%";
-        const form = new FormData();
-        form.append("video", selectedFile, selectedFile.name || "mediafile");
-
-        try {
-          const resp = await fetch(target_url, { method: "POST", body: form });
-          const text = await resp.text();
-          pbar.style.width = "100%";
-          if (resp.ok) {
-            statusEl.textContent = "Conclu√≠do!";
-            const data = JSON.parse(text);
-            const contagem = data.contagem_final;
-            const area = parseFloat(areaInput.value);
-            const preco = dados_preco.preco_kg;
-            const peso = dados_preco.peso_medio_g / 1000;
-            let html = `TIPO: ${isVideoRequest ? "V√çDEO" : "IMAGEM"}\n`;
-            html += `CONTAGEM: ${contagem}\n\n`;
-            let kg_ha = 0;
-            if (isVideoRequest) {
-               const kg_m2 = (contagem * peso) / area;
-               kg_ha = Math.round(kg_m2 * M2_POR_HECTARE);
-               const qntd_ha = Math.round((contagem / area) * M2_POR_HECTARE);
-               html += `ESTIMATIVA (QNTD): ${formatterInt.format(qntd_ha)} MANGAS/HA\n`;
-               html += `ESTIMATIVA (KG/HA): ${formatterInt.format(kg_ha)} KG/HA\n`;
-               html += `FATURAMENTO: R$ ${formatterCurrency.format(kg_ha * preco)}`;
-            } else { html += "ESTIMATIVA: N/A (Requer v√≠deo)"; }
-            resultadoDetalhado.textContent = html;
-            const futuro = 2.50;
-            forecastMessage.textContent = `Hoje: R$ ${formatterCurrency.format(preco)}. Dia 15/12: R$ ${formatterCurrency.format(futuro)}. Venda recomendada!`;
-            btnAgenda.onclick = () => {
-               const url = new URL("https://calendar.google.com/calendar/render?action=TEMPLATE");
-               url.searchParams.append('text', "Venda Manga (CyberAgro)");
-               url.searchParams.append('details', html);
-               window.open(url.href, '_blank');
-            };
-            out.innerHTML = `<button id="btnVerResultado" class="btn-nova-contagem">Ver Resultado</button>`;
-            document.getElementById("btnVerResultado").onclick = () => {
-               renderChart(['3/10','10/10','17/10','24/10','31/10','7/11'], [2.51, 1.26, 1.95, 1.88, 2.06, 1.86]);
-               nav('resultado-screen');
-            };
-          } else { statusEl.textContent = "Erro no processamento."; out.textContent = text; }
-        } catch (e) { statusEl.textContent = "Erro de rede."; } finally { btnSend.disabled = false; }
-      });
-      
-      // --- L√ìGICA DO CHAT NATIVO COM WEBHOOK ---
-      const chatMessages = document.getElementById('chatMessages');
-      const chatInput = document.getElementById('chatInput');
-      const chatSendBtn = document.getElementById('chatSendBtn');
-      let isTyping = false;
-      
-      function formatTime() {
-        const now = new Date();
-        return now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
-      }
-      
-      function addMessage(text, isUser = false) {
-        // Remove empty state se existir
-        const emptyState = chatMessages.querySelector('.chat-empty-state');
-        if (emptyState) emptyState.remove();
-        
-        const messageDiv = document.createElement('div');
-        messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;
-        
-        const avatar = document.createElement('div');
-        avatar.className = 'chat-message-avatar';
-        if (isUser) {
-          avatar.textContent = 'Voc√™';
-        } else {
-          const img = document.createElement('img');
-          img.src = 'logo.png?v=9';
-          img.alt = 'Bot';
-          img.style.width = '100%';
-          img.style.height = '100%';
-          img.style.borderRadius = '50%';
-          img.style.objectFit = 'cover';
-          avatar.appendChild(img);
-        }
-        
-        const contentWrapper = document.createElement('div');
-        contentWrapper.style.display = 'flex';
-        contentWrapper.style.flexDirection = 'column';
-        contentWrapper.style.maxWidth = '100%';
-        
-        const content = document.createElement('div');
-        content.className = 'chat-message-content';
-        // Markdown para mensagens do bot, texto simples para usu√°rio
-        let rendered;
-        if (isUser) {
-          rendered = text
-            .replace(/&/g, '&amp;')
-            .replace(/</g, '&lt;')
-            .replace(/>/g, '&gt;')
-            .replace(/\n/g, '<br>');
-        } else if (window.marked) {
-          rendered = marked.parse(text);
-        } else {
-          rendered = text.replace(/\n/g, '<br>');
-        }
-        content.innerHTML = rendered;
-        
-        const time = document.createElement('div');
-        time.className = 'chat-message-time';
-        time.textContent = formatTime();
-        
-        contentWrapper.appendChild(content);
-        contentWrapper.appendChild(time);
-        
-        messageDiv.appendChild(avatar);
-        messageDiv.appendChild(contentWrapper);
-        chatMessages.appendChild(messageDiv);
-        
-        // Scroll suave para o final
-        setTimeout(() => {
-          chatMessages.scrollTo({
-            top: chatMessages.scrollHeight,
-            behavior: 'smooth'
-          });
-        }, 100);
-      }
-      
-      function showTypingIndicator() {
-        if (isTyping) return;
-        isTyping = true;
-        
-        const typingDiv = document.createElement('div');
-        typingDiv.className = 'chat-message bot';
-        typingDiv.id = 'typingIndicator';
-        
-        const avatar = document.createElement('div');
-        avatar.className = 'chat-message-avatar';
-        const img = document.createElement('img');
-        img.src = 'logo.png?v=9';
-        img.alt = 'Bot';
-        img.style.width = '100%';
-        img.style.height = '100%';
-        img.style.borderRadius = '50%';
-        img.style.objectFit = 'cover';
-        avatar.appendChild(img);
-        
-        const indicator = document.createElement('div');
-        indicator.className = 'chat-typing-indicator';
-        indicator.innerHTML = '<div class="chat-typing-dot"></div><div class="chat-typing-dot"></div><div class="chat-typing-dot"></div>';
-        
-        typingDiv.appendChild(avatar);
-        typingDiv.appendChild(indicator);
-        chatMessages.appendChild(typingDiv);
-        
-        setTimeout(() => {
-          chatMessages.scrollTo({
-            top: chatMessages.scrollHeight,
-            behavior: 'smooth'
-          });
-        }, 100);
-      }
-      
-      function hideTypingIndicator() {
-        const indicator = document.getElementById('typingIndicator');
-        if (indicator) {
-          indicator.remove();
-          isTyping = false;
-        }
-      }
-      
-      async function sendMessage() {
-        const message = chatInput.value.trim();
-        if (!message || isTyping) return;
-        
-        // Adiciona mensagem do usu√°rio
-        addMessage(message, true);
-        chatInput.value = '';
-        chatSendBtn.disabled = true;
-        
-        // Mostra indicador de digita√ß√£o
-        showTypingIndicator();
-        
-        try {
-          // Obt√©m ou cria um chatId para manter a sess√£o
-          let chatId = localStorage.getItem('chatSessionId');
-          if (!chatId) {
-            chatId = `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
-            localStorage.setItem('chatSessionId', chatId);
-          }
-          
-          // Prepara o payload para o webhook do n8n
-          const payload = {
-            message: message,
-            text: message,
-            chatId: chatId,
-            sessionId: chatId
-          };
-          
-          console.log('Enviando para webhook:', N8N_CHAT_URL);
-          console.log('Payload:', payload);
-          
-          // Envia para o Webhook do n8n via HTTP POST
-          // O n8n webhook espera os dados no body da requisi√ß√£o
-          const response = await fetch(N8N_CHAT_URL, {
-            method: 'POST',
-            headers: {
-              'Content-Type': 'application/json',
-              'Accept': 'application/json'
-            },
-            mode: 'cors', // Permite CORS
-            credentials: 'omit', // N√£o envia cookies
-            body: JSON.stringify(payload)
-          });
-          
-          // Verifica se a requisi√ß√£o foi feita
-          if (!response) {
-            throw new Error('Nenhuma resposta recebida do servidor');
-          }
-          
-          console.log('Response status:', response.status);
-          console.log('Response headers:', response.headers);
-          
-          hideTypingIndicator();
-          
-          if (response.ok) {
-            let data;
-            const contentType = response.headers.get('content-type');
-            const responseText = await response.text();
-            
-            console.log('Response text:', responseText);
-            console.log('Content-Type:', contentType);
-            
-            if (contentType && contentType.includes('application/json')) {
-              try {
-                data = JSON.parse(responseText);
-                console.log('Response data:', data);
-              } catch (e) {
-                console.error('Erro ao parsear JSON:', e);
-                data = { output: responseText, response: responseText };
-              }
-            } else {
-              try {
-                data = JSON.parse(responseText);
-              } catch {
-                data = { output: responseText, response: responseText };
-              }
-            }
-            
-            // Webhook do n8n retorna em diferentes formatos
-            const botMessage = data.output || 
-                              data.response || 
-                              data.message || 
-                              data.text || 
-                              data.answer || 
-                              (typeof data === 'string' ? data : 'Desculpe, n√£o consegui processar sua mensagem.');
-            
-            console.log('Mensagem extra√≠da:', botMessage);
-            addMessage(botMessage, false);
-            
-            // Atualiza chatId se fornecido na resposta
-            if (data.chatId) {
-              localStorage.setItem('chatSessionId', data.chatId);
-            }
-          } else {
-            const errorText = await response.text();
-            console.error('Erro HTTP:', response.status, errorText);
-            
-            let errorMessage = 'Desculpe, ocorreu um erro ao processar sua mensagem.';
-            
-            try {
-              const errorData = JSON.parse(errorText);
-              errorMessage = errorData.message || errorData.error || errorMessage;
-              console.error('Erro parseado:', errorData);
-            } catch {
-              if (errorText) {
-                console.error('Erro detalhado (texto):', errorText);
-              }
-            }
-            
-            addMessage(`Erro ${response.status}: ${errorMessage}. Tente novamente.`, false);
-          }
-        } catch (error) {
-          hideTypingIndicator();
-          console.error('Erro completo no chat:', error);
-          console.error('Stack trace:', error.stack);
-          
-          let errorMsg = 'Erro de conex√£o. ';
-          if (error.message) {
-            errorMsg += error.message;
-          } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
-            errorMsg += 'N√£o foi poss√≠vel conectar ao servidor. Verifique se o webhook est√° ativo no n8n.';
-          } else {
-            errorMsg += 'Verifique sua internet e tente novamente.';
-          }
-          
-          addMessage(errorMsg, false);
-        } finally {
-          chatSendBtn.disabled = false;
-          chatInput.focus();
-        }
-      }
-      
-      // Event listeners do chat
-      if (chatSendBtn && chatInput) {
-        chatSendBtn.addEventListener('click', sendMessage);
-        chatInput.addEventListener('keypress', (e) => {
-          if (e.key === 'Enter' && !e.shiftKey) {
-            e.preventDefault();
-            sendMessage();
-          }
-        });
-      }
-      
-      // Fun√ß√µes Globais para os bot√µes onclick do HTML
-      window.nav = nav;
-      window.resetUI = resetUI;
-    });
-  </script>
+  <script type="module">
+    // 1. IMPORTAR FIREBASE
+    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
+    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
+    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
+
+    // 2. CONFIGURA√á√ÉO (SEU PROJETO NOVO)
+    const firebaseConfig = {
+      apiKey: "AIzaSyAyIWfUq2XcM8NGtTY3WXi0Q5irRsJdkgc",
+      authDomain: "cyberagro-90b43.firebaseapp.com",
+      projectId: "cyberagro-90b43",
+      storageBucket: "cyberagro-90b43.firebasestorage.app",
+      messagingSenderId: "174960456565",
+      appId: "1:174960456565:web:77fd9eb2bff33da20f993c"
+    };
+
+    const app = initializeApp(firebaseConfig);
+    const auth = getAuth(app);
+    const db = getFirestore(app);
+
+    // Vari√°veis Globais
+    let ultimaContagemParaSalvar = 0;
+    let dadosExtrasParaSalvar = "";
+
+    // --- L√ìGICA DE LOGIN ---
+    const emailInput = document.getElementById('emailInput');
+    const passInput = document.getElementById('passwordInput');
+    const loginError = document.getElementById('loginError');
+
+    // Bot√£o Entrar
+    document.getElementById('btnLogin').onclick = () => {
+        if(!emailInput.value || !passInput.value) return alert("Preencha e-mail e senha");
+        document.getElementById('btnLogin').textContent = "Entrando...";
+        signInWithEmailAndPassword(auth, emailInput.value, passInput.value).catch(err => {
+            loginError.style.display = 'block';
+            loginError.textContent = "Erro: " + err.message;
+            document.getElementById('btnLogin').textContent = "Entrar";
+        });
+    };
+
+    // Bot√£o Criar Conta
+    document.getElementById('btnRegister').onclick = () => {
+        if(!emailInput.value || !passInput.value) return alert("Preencha e-mail e senha");
+        createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
+            .then(() => alert("Conta criada com sucesso!"))
+            .catch(err => alert("Erro ao criar: " + err.message));
+    };
+
+    // Bot√£o Sair
+    document.getElementById('navSair').onclick = (e) => {
+        e.preventDefault();
+        if(confirm("Sair da conta?")) signOut(auth);
+    };
+
+    // --- O PORTEIRO (MONITOR DE SESS√ÉO) ---
+    onAuthStateChanged(auth, (user) => {
+        if (user) {
+            // USU√ÅRIO LOGADO
+            console.log("Logado:", user.email);
+            
+            // Atualiza Perfil
+            const perfilNome = document.querySelector('.profile-name');
+            const perfilEmail = document.querySelector('.profile-subtitle');
+            if(perfilNome) perfilNome.textContent = "Usu√°rio Conectado";
+            if(perfilEmail) perfilEmail.textContent = user.email;
+
+            // Carrega Hist√≥rico do Banco
+            carregarHistorico(user.uid);
+
+            window.nav('selecao-cultura-screen');
+        } else {
+            // USU√ÅRIO DESLOGADO
+            window.nav('login-screen');
+        }
+    });
+
+    // --- FUN√á√ïES DE BANCO DE DADOS ---
+    async function salvarNoBanco() {
+        const user = auth.currentUser;
+        if (!user) return alert("Erro: Voc√™ precisa estar logado.");
+        
+        try {
+            await addDoc(collection(db, "users", user.uid, "contagens"), {
+                qtd: parseInt(ultimaContagemParaSalvar),
+                detalhes: dadosExtrasParaSalvar,
+                data: new Date(),
+                tipo: "Manga"
+            });
+            alert("‚úÖ Salvo no seu hist√≥rico pessoal!");
+            window.nav('dashboard-screen');
+        } catch(e) {
+            alert("Erro ao salvar: " + e.message);
+        }
+    }
+
+    function carregarHistorico(uid) {
+        // Busca na pasta do usu√°rio
+        const q = query(collection(db, "users", uid, "contagens"), orderBy("data", "desc"));
+        onSnapshot(q, (snapshot) => {
+            let total = 0;
+            const lista = document.querySelector('.data-list'); // Sua lista do dashboard
+            if(!lista) return;
+            
+            lista.innerHTML = ""; // Limpa lista antiga
+            
+            snapshot.forEach(doc => {
+                const d = doc.data();
+                total += d.qtd;
+                
+                // Cria item na lista (Usando seu estilo CSS)
+                const li = document.createElement('li');
+                li.className = 'data-row';
+                const dataFmt = d.data && d.data.seconds ? new Date(d.data.seconds*1000).toLocaleDateString('pt-BR') : 'Hoje';
+                li.innerHTML = `<span>Manga (${dataFmt})</span> <span>${d.qtd} unid.</span>`;
+                lista.appendChild(li);
+            });
+
+            // Atualiza totais do Dashboard
+            const cards = document.querySelectorAll('.summary-card .value');
+            if(cards.length > 0) cards[0].textContent = total; // Total Contagens
+        });
+    }
+
+    // --- SUA L√ìGICA DE NAVEGA√á√ÉO E APP (MANTIDA) ---
+    window.nav = function(telaId) {
+        const telas = ['login-screen', 'selecao-cultura-screen', 'dashboard-screen', 'app-screen', 'resultado-screen', 'chat-screen', 'perfil-screen'];
+        telas.forEach(id => {
+            const el = document.getElementById(id);
+            if(el) {
+                el.classList.add('hide');
+                el.style.display = 'none';
+            }
+        });
+        
+        const atual = document.getElementById(telaId);
+        if(atual) {
+            atual.classList.remove('hide');
+            atual.style.display = (telaId === 'chat-screen') ? 'flex' : 'block';
+        }
+
+        // Controla Rodap√©
+        const footer = document.querySelector('.app-footer');
+        const fab = document.getElementById('btnChat');
+        const isLogin = (telaId === 'login-screen' || telaId === 'selecao-cultura-screen');
+        if(footer) footer.style.display = isLogin ? 'none' : 'flex';
+        if(fab) fab.style.display = isLogin ? 'none' : 'block';
+    }
+
+    // Bot√µes de Navega√ß√£o
+    document.getElementById('btnIconeManga').onclick = () => window.nav('dashboard-screen');
+    document.getElementById('btnSalvarBanco').onclick = salvarNoBanco;
+
+    // --- L√ìGICA DA IA (MANTIDA INTEGRALMENTE) ---
+    const fileInput = document.getElementById("fileInput");
+    const btnSend = document.getElementById("btnSend");
+    const statusEl = document.getElementById("status");
+    const previewVideo = document.getElementById("previewVideo");
+    const previewImage = document.getElementById("previewImage");
+    const resultDetails = document.getElementById("resultado-detalhado");
+    const forecast = document.getElementById("forecast-message");
+    
+    // Fun√ß√µes auxiliares
+    const formatterCurrency = new Intl.NumberFormat('pt-BR', { style: 'decimal', minimumFractionDigits: 2 });
+    window.resetUI = function() {
+       fileInput.value = "";
+       document.getElementById('areaInput').value = "";
+       previewVideo.style.display = "none";
+       previewImage.style.display = "none";
+       btnSend.disabled = true;
+       document.getElementById('out').innerHTML = "‚Äî";
+    }
+    document.getElementById('btnClear').onclick = window.resetUI;
+
+    fileInput.onchange = (e) => {
+        const file = e.target.files[0];
+        if(!file) return;
+        
+        document.getElementById('fileInfo').textContent = file.name;
+        btnSend.disabled = false;
+        const url = URL.createObjectURL(file);
+        
+        if(file.type.startsWith("video")) {
+            previewVideo.src = url; previewVideo.style.display = "block"; previewImage.style.display = "none";
+            document.getElementById('areaInput').style.display = "block";
+        } else {
+            previewImage.src = url; previewImage.style.display = "block"; previewVideo.style.display = "none";
+            document.getElementById('areaInput').style.display = "none";
+        }
+    };
+
+    btnSend.onclick = async () => {
+        const file = fileInput.files[0];
+        statusEl.textContent = "Enviando para IA...";
+        document.getElementById('pbar').style.width = "30%";
+        
+        const form = new FormData();
+        form.append("video", file);
+        const API = file.type.startsWith('video') 
+            ? "https://contador-manga-476522137012.us-central1.run.app/contar"
+            : "https://contador-manga-476522137012.us-central1.run.app/contar-imagem";
+
+        try {
+            const resp = await fetch(API, { method: "POST", body: form });
+            const data = await resp.json();
+            
+            document.getElementById('pbar').style.width = "100%";
+            statusEl.textContent = "Conclu√≠do!";
+            
+            const contagem = data.contagem_final || 0;
+            ultimaContagemParaSalvar = contagem; // Guarda para o bot√£o salvar
+            
+            // Seus c√°lculos originais
+            const area = parseFloat(document.getElementById('areaInput').value) || 1;
+            const kg_ha = Math.round(((contagem * 0.5) / area) * 10000);
+            
+            let html = `TIPO: ${file.type.startsWith("video") ? "V√çDEO" : "FOTO"}\n`;
+            html += `CONTAGEM: ${contagem}\n`;
+            if(file.type.startsWith("video")) {
+                html += `ESTIMATIVA: ${kg_ha} KG/HA\n`;
+                dadosExtrasParaSalvar = `${kg_ha} KG/HA`;
+            }
+            
+            resultDetails.textContent = html;
+            forecast.textContent = `Previs√£o de Venda: R$ ${formatterCurrency.format(kg_ha * 1.86)}`;
+            
+            // Habilita visualiza√ß√£o
+            document.getElementById('out').innerHTML = `<button onclick="window.nav('resultado-screen')" class="btn-nova-contagem">Ver Resultado</button>`;
+            
+            // Gera gr√°fico (Chart.js)
+            const ctx = document.getElementById('myChart').getContext('2d');
+            new Chart(ctx, {
+                type: 'line',
+                data: { labels: ['Out', 'Nov', 'Dez'], datasets: [{ label: 'Pre√ßo', data: [2.5, 1.8, 1.2], borderColor: '#28a745' }] }
+            });
+
+        } catch(e) {
+            statusEl.textContent = "Erro IA (Modo Demo)";
+            // Fallback demo para voc√™ n√£o ficar travado
+            ultimaContagemParaSalvar = 150;
+            resultDetails.textContent = "DEMO: 150 Mangas Detectadas";
+            document.getElementById('out').innerHTML = `<button onclick="window.nav('resultado-screen')" class="btn-nova-contagem">Ver Resultado</button>`;
+        }
+    };
+
+    // --- SEU CHAT ORIGINAL (MANTIDO) ---
+    const chatInput = document.getElementById('chatInput');
+    const chatBtn = document.getElementById('chatSendBtn');
+    const chatMsgs = document.getElementById('chatMessages');
+
+    chatBtn.onclick = async () => {
+        const txt = chatInput.value;
+        if(!txt) return;
+        
+        // Msg User
+        const divUser = document.createElement('div');
+        divUser.className = 'chat-message user';
+        divUser.innerHTML = `<div class="chat-message-content">${txt}</div>`;
+        chatMsgs.appendChild(divUser);
+        chatInput.value = "";
+        
+        // Webhook
+        try {
+            const req = await fetch("https://n8n-agent-476522137012.us-central1.run.app/webhook/chat", {
+                method: "POST", headers: {'Content-Type': 'application/json'},
+                body: JSON.stringify({ message: txt, chatId: "web_"+Date.now() })
+            });
+            const res = await req.json();
+            const botTxt = res.output || res.message || "Recebido.";
+            
+            const divBot = document.createElement('div');
+            divBot.className = 'chat-message bot';
+            divBot.innerHTML = `<div class="chat-message-content">${marked.parse(botTxt)}</div>`;
+            chatMsgs.appendChild(divBot);
+        } catch(e) { console.log(e); }
+    };
+  </script>
 </body>
 </html>
