<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CyberAgro</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFFFFF">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/app-mvp1/sw.js')
        .then(reg => {
            reg.update();
            console.log('Service Worker Registrado v10');
        })
        .catch(err => console.log('Service Worker falhou:', err));
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- marked.js para processar Markdown das mensagens do bot -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* --- ESTILOS GERAIS --- */
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; }
    body { margin: 0 0 80px 0; background: #FFFFFF; color: #333333; height: 100vh; overflow-x: hidden; }
    .wrap { max-width: 640px; margin: 0 auto; padding: 16px; }
    .card { background: #F8F8F8; border: 1px solid #E0E0E0; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { background: #2a7bf6; color: white; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .muted { color: #555555; font-size: .9rem; text-align: center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; word-break: break-word; color: #333333; }
    h3 { margin-top: 20px; margin-bottom: 10px; }
    .btn-upload { position: relative; display: inline-block; background: #E6EEFA; color: #2a7bf6; border: 1px dashed #2a7bf6; }
    .file-proxy { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .area-input { font-family: inherit; font-size: 1rem; padding: 10px 14px; border: 1px solid #E0E0E0; border-radius: 12px; background: #FFFFFF; flex-grow: 1; min-width: 150px; }
    .progress { height: 6px; background: #E0E0E0; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #2a7bf6; transition: width .2s; }
    #previewVideo, #previewImage { width: 100%; border-radius: 12px; background: #000; margin-top: 10px; }
    .login-error { color: #D32F2F; font-size: 0.9rem; text-align: center; margin-top: 10px; display: none; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .summary-card { background: #EEEEEE; border: 1px solid #E0E0E0; border-radius: 16px; padding: 16px; }
    .summary-card label { display: block; font-size: 0.8rem; color: #555555; margin-bottom: 4px; text-transform: uppercase; }
    .summary-card .value { font-size: 1.25rem; font-weight: 600; color: #333; }
    .data-list { list-style: none; padding: 0; margin: 0; }
    .data-row { display: flex; justify-content: space-between; padding: 14px 8px; border-bottom: 1px solid #EEE; font-size: 0.9rem; }
    .data-row span:first-child { color: #333; }
    .data-row span:last-child { color: #555; font-weight: 500; }
    .btn-nova-contagem {
      background: #28a745; /* Verde */
      color: white;
      border: 0;
      border-radius: 12px;
      padding: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      font-size: 1.1rem;
      margin-top: 20px;
    }
    
    /* --- CHAT NATIVO PROFISSIONAL --- */
    .chat-frame-container {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        z-index: 900;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 18px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        position: relative;
    }
    
    .chat-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255,255,255,0.2);
    }
    
    .chat-header-btn {
        background: rgba(255,255,255,0.25);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 22px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
    }
    
    .chat-header-btn:hover {
        background: rgba(255,255,255,0.35);
        transform: translateX(-2px);
    }
    
    .chat-header-title {
        flex: 1;
        font-size: 1.15rem;
        font-weight: 600;
        letter-spacing: -0.3px;
    }
    
    .chat-header-status {
        font-size: 0.75rem;
        opacity: 0.9;
        font-weight: 400;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        scroll-behavior: smooth;
        background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.3);
    }
    
    .chat-message {
        display: flex;
        gap: 10px;
        animation: messageSlideIn 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        max-width: 85%;
        align-self: flex-start;
    }
    
    .chat-message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }
    
    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(15px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .chat-message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        flex-shrink: 0;
        font-size: 0.85rem;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        border: 2px solid white;
        overflow: hidden;
    }

    /* √öNICA ALTERA√á√ÉO: fundo branco apenas para o avatar do bot */
    .chat-message.bot .chat-message-avatar {
        background: #ffffff;
    }
    
    .chat-message.user .chat-message-avatar {
        background: linear-gradient(135deg, #2a7bf6 0%, #1e5fd4 100%);
        box-shadow: 0 2px 8px rgba(42, 123, 246, 0.3);
    }
    
    .chat-message-content {
        padding: 14px 18px;
        border-radius: 20px;
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 0.95rem;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .chat-message.bot .chat-message-content {
        background: white;
        color: #2c3e50;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    
    .chat-message.user .chat-message-content {
        background: linear-gradient(135deg, #2a7bf6 0%, #1e5fd4 100%);
        color: white;
        border-bottom-right-radius: 6px;
        box-shadow: 0 4px 12px rgba(42, 123, 246, 0.25);
    }
    
    .chat-message-time {
        font-size: 0.7rem;
        opacity: 0.6;
        margin-top: 4px;
        padding-left: 2px;
    }
    
    .chat-input-container {
        background: white;
        border-top: 1px solid rgba(0,0,0,0.08);
        padding: 16px 20px;
        display: flex;
        gap: 12px;
        align-items: center;
        box-shadow: 0 -2px 12px rgba(0,0,0,0.05);
    }
    
    .chat-input {
        flex: 1;
        border: 2px solid #e9ecef;
        border-radius: 26px;
        padding: 12px 20px;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.2s ease;
        font-family: inherit;
        background: #f8f9fa;
    }
    
    .chat-input:focus {
        border-color: #28a745;
        background: white;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }
    
    .chat-send-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12pxrgba(40, 167, 69, 0.3);
        font-weight: 600;
    }
    
    .chat-send-btn:hover:not(:disabled) {
        transform: scale(1.08);
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
    }
    
    .chat-send-btn:active:not(:disabled) {
        transform: scale(1.02);
    }
    
    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: scale(1);
    }
    
    .chat-typing-indicator {
        display: flex;
        gap: 5px;
        padding: 14px 18px;
        background: white;
        border-radius: 20px;
        border-bottom-left-radius: 6px;
        max-width: 70px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .chat-typing-dot {
        width: 9px;
        height: 9px;
        background: #adb5bd;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }
    
    .chat-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .chat-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typingBounce {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.7;
        }
        30% {
            transform: translateY(-12px);
            opacity: 1;
        }
    }
    
    .chat-empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        text-align: center;
        padding: 60px 20px;
    }
    
    .chat-empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.4;
        filter: grayscale(0.3);
    }
    
    .chat-empty-state-text {
        font-size: 1.05rem;
        color: #6c757d;
        font-weight: 500;
        max-width: 280px;
        line-height: 1.6;
    }
    
    @media (max-width: 480px) {
        .chat-message {
            max-width: 90%;
        }
        
        .chat-header {
            padding: 16px 16px;
        }
        
        .chat-messages {
            padding: 20px 16px;
        }
        
        .chat-input-container {
            padding: 14px 16px;
        }
    }
    /* ----------------------------- */

    /* Rodap√© come√ßa oculto */
    .app-footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #FFFFFF; border-top: 1px solid #E0E0E0;
      display: none;
      justify-content: space-around; align-items: center;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999;
      padding: 0 10px; height: 60px;
    }

    /* Chat come√ßa oculto */
    .chat-fab {
      position: fixed; bottom: 90px; right: 20px; background: #28a745;
      color: white; width: 50px; height: 50px; border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; 
      display: none;
      box-sizing: border-box;
      padding: 10px; 
    }

    .footer-btn {
      flex: 1; text-align: center; padding: 10px 5px;
      font-size: 0.8rem; text-decoration: none; color: #888888; 
      background: none; border: none;
    }
    .footer-btn.active { color: #28a745; font-weight: 600; }
    
    .footer-btn-central {
      background: #000000; color: white;
      width: 60px; height: 60px;
      text-align: center; text-decoration: none;
      border-radius: 50%;
      position: relative; top: -20px;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.15);
      border: 4px solid white; 
      padding: 0; box-sizing: border-box; overflow: hidden;
    }
    .footer-btn-central img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    .chat-fab img { width: 100%; height: 100%; object-fit: cover; display: block; }

    #agenda-section { margin-top: 20px; border-top: 1px solid #E0E0E0; padding-top: 15px; }
    #grafico-placeholder { width: 100%; height: 250px; background: #EEEEEE; border-radius: 12px; }
    
    /* CSS da Sele√ß√£o de Cultura */
    .cultura-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .cultura-btn {
      background: #F8F8F8; border: 1px solid #E0E0E0; border-radius: 12px;
      padding: 15px 5px; text-decoration: none; color: #333;
      font-size: 0.8rem; font-weight: 600; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .cultura-btn:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
    .cultura-btn img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; }
    
    /* Estilos Perfil */
    .profile-header { display: flex; align-items: center; gap: 16px; }
    .profile-pic { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #DDD; }
    .profile-name { font-size: 1.2rem; font-weight: 600; color: #333; }
    .profile-subtitle { font-size: 0.9rem; color: #555; }
    .menu-list { margin-top: 20px; padding: 0; }
    .menu-item { display: flex; align-items: center; padding: 16px; text-decoration: none; color: #333; font-size: 1rem; border-bottom: 1px solid #EEE; }
    .menu-item:last-child { border-bottom: none; }
    .menu-item.danger { color: #D32F2F; } 
    .menu-icon { font-size: 1.2rem; margin-right: 16px; width: 24px; text-align: center; }
    .menu-chevron { margin-left: auto; color: #AAA; font-weight: 600; }
    
    /* Helper */
    .hide { display: none !important; }
  </style>
</head>
<body>

  <div id="login-screen" class="wrap" style="text-align: center; padding-top: 40px;">
    <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=7" alt="CyberAgro Logo" height="250"></h1>
    <div class="card">
      <h3 style="text-align: center;">Acesso CyberAgro</h3>
      <p class="muted" style="text-align: left;">Entre ou crie sua conta para salvar o hist√≥rico.</p>
      
      <input type="email" id="emailInput" class="area-input" placeholder="seu@email.com" style="width:100%; box-sizing: border-box; margin-bottom:10px;">
      <input type="password" id="passwordInput" placeholder="Senha" class="area-input" style="width:100%; box-sizing: border-box;">
      
      <p id="loginError" class="login-error">Erro ao entrar.</p>
      
      <button id="btnLogin" style="width:100%; margin-top: 12px;">Entrar</button>
      <button id="btnRegister" style="width:100%; margin-top: 10px; background: transparent; border: 1px solid #2a7bf6; color: #2a7bf6;">Criar Nova Conta</button>
    </div>
  </div>

  <div id="selecao-cultura-screen" class="wrap hide">
    <h1 style="text-align:center;margin-bottom:16px;"><img src="logo.png?v=7" alt="CyberAgro Logo" height="250"></h1>
    <div class="card">
      <h3 style="text-align: center;">Selecione a Cultura</h3>
      <div class="cultura-grid">
        <div id="btnIconeManga" class="cultura-btn">
          <img src="manga.png" alt="Manga"><span>Manga</span>
        </div>
        <div id="btnIconeUva" class="cultura-btn">
          <img src="uva.png" alt="Uva"><span>Uva</span>
        </div>
        <div id="btnIconePitaya" class="cultura-btn">
          <img src="pitaya.png" alt="Pitaya"><span>Pitaya</span>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard-screen" class="wrap hide">
    <h3>Vis√£o Geral</h3>
    <div class="summary-grid">
      <div class="summary-card"><label>Contagens no Ano</label><div class="value">312</div></div>
      <div class="summary-card"><label>Est. Faturamento Anual</label><div class="value">R$ 13.491.152</div></div>
    </div>
    <h3>Produtividade Mensal</h3>
    <ul class="data-list card">
      <li class="data-row"><span>Dezembro</span> <span>R$ 0,00</span></li>
      <li class="data-row"><span>Novembro</span> <span>R$ 0,00</span></li>
      <li class="data-row"><span>Janeiro</span> <span>R$ 0,00</span></li>
    </ul>
  </div>

  <div id="app-screen" class="wrap hide">
    <button onclick="nav('dashboard-screen')" style="background:#555; margin-bottom:15px;">VOLTAR AO INICIO</button>
    <p class="muted">Anexe um v√≠deo ou imagem para a contagem da IA.</p>
    <div class="card" id="app">
      <div class="row">
        <button id="btnSelect" class="btn-upload">1. Escolher V√≠deo/Imagem‚Ä¶
          <input id="fileInput" class="file-proxy" type="file" accept="video/*,image/*">
        </button>
        <input type="number" id="areaInput" placeholder="√Årea (m¬≤) (s√≥ p/ v√≠deo)" class="area-input" style="display:none;">
      </div>
      <div class="row" style="margin-top: 12px;">
         <button id="btnSend" disabled>2. Enviar para IA</button>
         <button id="btnClear" disabled style="background:#eee;color:#333;">Limpar</button>
      </div>
      <div style="margin:12px 0;text-align:left;">
        <div class="progress"><div id="pbar" class="bar"></div></div>
        <div style="margin-top:8px">Status: <span id="status" class="mono">aguardando ficheiro...</span></div>
        <div id="fileInfo" class="muted" style="text-align:left;margin-top:8px;">Nenhum ficheiro selecionado.</div>
        <video id="previewVideo" controls playsinline style="display:none;"></video>
        <img id="previewImage" src="" alt="Preview da Imagem" style="display:none;">
      </div>
      <div>
        <h3>Resultado</h3>
        <pre id="out" class="mono">‚Äî</pre>
      </div>
    </div>
  </div>

  <div id="resultado-screen" class="wrap hide">
    <button onclick="nav('dashboard-screen')" style="background:#555; margin-bottom:15px;">VOLTAR AO INICIO</button>
    <div class="card">
      <h3>Resultado Detalhado</h3>
      <pre id="resultado-detalhado" class="mono"></pre>
      <button id="btnSalvarBanco" class="btn-nova-contagem" style="background:#2a7bf6; margin-top:10px;">
        üíæ Salvar no Hist√≥rico Pessoal
      </button>
      <h3 style="margin-top: 20px;">Gr√°fico Anual</h3>
      <canvas id="myChart" height="200"></canvas> 
      <div id="agenda-section" style="margin-top: 20px; border-top: 1px solid #E0E0E0; padding-top: 15px;">
        <h3 style="margin-top: 0;">Previs√£o de Venda</h3>
        <p id="forecast-message" class="mono" style="font-size: 0.9rem;"></p>
        <button id="btnAgenda" class="btn-nova-contagem" style="background-color: #f0ad4e; margin-top: 10px;">
          Deseja adicionar um lembrete na sua agenda?
        </button>
      </div>
    </div>
  </div>
  
  <div id="chat-screen" class="chat-frame-container hide">
    <div class="chat-header">
      <button onclick="nav('dashboard-screen')" class="chat-header-btn">‚Üê Voltar</button>
      <div style="flex: 1;">
        <div class="chat-header-title">CyberAgro Assistente</div>
        <div class="chat-header-status">Online</div>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-empty-state">
        <div class="chat-empty-state-icon">üí¨</div>
        <div class="chat-empty-state-text">Ol√°! Sou seu assistente virtual. Como posso ajud√°-lo hoje?</div>
      </div>
    </div>
    <div class="chat-input-container">
      <input type="text" id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="chatSendBtn" class="chat-send-btn" title="Enviar mensagem">‚Üí</button>
    </div>
  </div>
  
  <div id="perfil-screen" class="wrap hide">
    <div class="profile-header card">
      <img src="logo.png?v=7" alt="Foto de Perfil" class="profile-pic">
      <div class="profile-info">
        <div class="profile-name">CyberAgro</div>
        <div class="profile-subtitle">cyberagro.contato@gmail.com</div>
      </div>
    </div>
    <div class="menu-list card">
      <a href="#" class="menu-item" id="navMeusDados"><span class="menu-icon">üë§</span> <span>Meus Dados</span> <span class="menu-chevron">&gt;</span></a>
      <a href="#" class="menu-item" id="navConfig"><span class="menu-icon">‚öôÔ∏è</span> <span>Configura√ß√µes</span> <span class="menu-chevron">&gt;</span></a>
      <a href="#" class="menu-item danger" id="navSair"><span class="menu-icon">üö™</span> <span>Sair</span> <span class="menu-chevron">&gt;</span></a>
    </div>
  </div>

  <div class="app-footer">
    <a onclick="nav('dashboard-screen')" class="footer-btn active">In√≠cio</a>
    <a onclick="nav('resultado-screen')" class="footer-btn">Relat√≥rios</a>
    <a onclick="nav('app-screen')" class="footer-btn-central"><img src="imagem1.jpeg" alt="Nova"></a>
    <a onclick="alert('Em breve')" class="footer-btn">Irriga√ß√£o</a> 
    <a onclick="nav('perfil-screen')" class="footer-btn">Perfil</a>
  </div>
  
  <button id="btnChat" class="chat-fab" onclick="nav('chat-screen')">
    <img src="imagem2.png" alt="Chat">
  </button>

  <script type="module">
    // 1. IMPORTAR FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. CONFIGURA√á√ÉO (SEU PROJETO NOVO)
    const firebaseConfig = {
      apiKey: "AIzaSyAyIWfUq2XcM8NGtTY3WXi0Q5irRsJdkgc",
      authDomain: "cyberagro-90b43.firebaseapp.com",
      projectId: "cyberagro-90b43",
      storageBucket: "cyberagro-90b43.firebasestorage.app",
      messagingSenderId: "174960456565",
      appId: "1:174960456565:web:77fd9eb2bff33da20f993c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Vari√°veis Globais
    let ultimaContagemParaSalvar = 0;
    let dadosExtrasParaSalvar = "";

    // --- L√ìGICA DE LOGIN ---
    const emailInput = document.getElementById('emailInput');
    const passInput = document.getElementById('passwordInput');
    const loginError = document.getElementById('loginError');

    // Bot√£o Entrar
    document.getElementById('btnLogin').onclick = () => {
        if(!emailInput.value || !passInput.value) return alert("Preencha e-mail e senha");
        document.getElementById('btnLogin').textContent = "Entrando...";
        signInWithEmailAndPassword(auth, emailInput.value, passInput.value).catch(err => {
            loginError.style.display = 'block';
            loginError.textContent = "Erro: " + err.message;
            document.getElementById('btnLogin').textContent = "Entrar";
        });
    };

    // Bot√£o Criar Conta
    document.getElementById('btnRegister').onclick = () => {
        if(!emailInput.value || !passInput.value) return alert("Preencha e-mail e senha");
        createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
            .then(() => alert("Conta criada com sucesso!"))
            .catch(err => alert("Erro ao criar: " + err.message));
    };

    // Bot√£o Sair
    document.getElementById('navSair').onclick = (e) => {
        e.preventDefault();
        if(confirm("Sair da conta?")) signOut(auth);
    };

    // --- O PORTEIRO (MONITOR DE SESS√ÉO) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // USU√ÅRIO LOGADO
            console.log("Logado:", user.email);
            
            // Atualiza Perfil
            const perfilNome = document.querySelector('.profile-name');
            const perfilEmail = document.querySelector('.profile-subtitle');
            if(perfilNome) perfilNome.textContent = "Usu√°rio Conectado";
            if(perfilEmail) perfilEmail.textContent = user.email;

            // Carrega Hist√≥rico do Banco
            carregarHistorico(user.uid);

            window.nav('selecao-cultura-screen');
        } else {
            // USU√ÅRIO DESLOGADO
            window.nav('login-screen');
        }
    });

    // --- FUN√á√ïES DE BANCO DE DADOS ---
    async function salvarNoBanco() {
        const user = auth.currentUser;
        if (!user) return alert("Erro: Voc√™ precisa estar logado.");
        
        try {
            await addDoc(collection(db, "users", user.uid, "contagens"), {
                qtd: parseInt(ultimaContagemParaSalvar),
                detalhes: dadosExtrasParaSalvar,
                data: new Date(),
                tipo: "Manga"
            });
            alert("‚úÖ Salvo no seu hist√≥rico pessoal!");
            window.nav('dashboard-screen');
        } catch(e) {
            alert("Erro ao salvar: " + e.message);
        }
    }

    function carregarHistorico(uid) {
        // Busca na pasta do usu√°rio
        const q = query(collection(db, "users", uid, "contagens"), orderBy("data", "desc"));
        onSnapshot(q, (snapshot) => {
            let total = 0;
            const lista = document.querySelector('.data-list'); // Sua lista do dashboard
            if(!lista) return;
            
            lista.innerHTML = ""; // Limpa lista antiga
            
            snapshot.forEach(doc => {
                const d = doc.data();
                total += d.qtd;
                
                // Cria item na lista (Usando seu estilo CSS)
                const li = document.createElement('li');
                li.className = 'data-row';
                const dataFmt = d.data && d.data.seconds ? new Date(d.data.seconds*1000).toLocaleDateString('pt-BR') : 'Hoje';
                li.innerHTML = `<span>Manga (${dataFmt})</span> <span>${d.qtd} unid.</span>`;
                lista.appendChild(li);
            });

            // Atualiza totais do Dashboard
            const cards = document.querySelectorAll('.summary-card .value');
            if(cards.length > 0) cards[0].textContent = total; // Total Contagens
        });
    }

    // --- SUA L√ìGICA DE NAVEGA√á√ÉO E APP (MANTIDA) ---
    window.nav = function(telaId) {
        const telas = ['login-screen', 'selecao-cultura-screen', 'dashboard-screen', 'app-screen', 'resultado-screen', 'chat-screen', 'perfil-screen'];
        telas.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('hide');
                el.style.display = 'none';
            }
        });
        
        const atual = document.getElementById(telaId);
        if(atual) {
            atual.classList.remove('hide');
            atual.style.display = (telaId === 'chat-screen') ? 'flex' : 'block';
        }

        // Controla Rodap√©
        const footer = document.querySelector('.app-footer');
        const fab = document.getElementById('btnChat');
        const isLogin = (telaId === 'login-screen' || telaId === 'selecao-cultura-screen');
        if(footer) footer.style.display = isLogin ? 'none' : 'flex';
        if(fab) fab.style.display = isLogin ? 'none' : 'block';
    }

    // Bot√µes de Navega√ß√£o
    document.getElementById('btnIconeManga').onclick = () => window.nav('dashboard-screen');
    document.getElementById('btnSalvarBanco').onclick = salvarNoBanco;

    // --- L√ìGICA DA IA (MANTIDA INTEGRALMENTE) ---
    const fileInput = document.getElementById("fileInput");
    const btnSend = document.getElementById("btnSend");
    const statusEl = document.getElementById("status");
    const previewVideo = document.getElementById("previewVideo");
    const previewImage = document.getElementById("previewImage");
    const resultDetails = document.getElementById("resultado-detalhado");
    const forecast = document.getElementById("forecast-message");
    
    // Fun√ß√µes auxiliares
    const formatterCurrency = new Intl.NumberFormat('pt-BR', { style: 'decimal', minimumFractionDigits: 2 });
    window.resetUI = function() {
       fileInput.value = "";
       document.getElementById('areaInput').value = "";
       previewVideo.style.display = "none";
       previewImage.style.display = "none";
       btnSend.disabled = true;
       document.getElementById('out').innerHTML = "‚Äî";
    }
    document.getElementById('btnClear').onclick = window.resetUI;

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('fileInfo').textContent = file.name;
        btnSend.disabled = false;
        const url = URL.createObjectURL(file);
        
        if(file.type.startsWith("video")) {
            previewVideo.src = url; previewVideo.style.display = "block"; previewImage.style.display = "none";
            document.getElementById('areaInput').style.display = "block";
        } else {
            previewImage.src = url; previewImage.style.display = "block"; previewVideo.style.display = "none";
            document.getElementById('areaInput').style.display = "none";
        }
    };

    btnSend.onclick = async () => {
        const file = fileInput.files[0];
        statusEl.textContent = "Enviando para IA...";
        document.getElementById('pbar').style.width = "30%";
        
        const form = new FormData();
        form.append("video", file);
        const API = file.type.startsWith('video') 
            ? "https://contador-manga-476522137012.us-central1.run.app/contar"
            : "https://contador-manga-476522137012.us-central1.run.app/contar-imagem";

        try {
            const resp = await fetch(API, { method: "POST", body: form });
            const data = await resp.json();
            
            document.getElementById('pbar').style.width = "100%";
            statusEl.textContent = "Conclu√≠do!";
            
            const contagem = data.contagem_final || 0;
            ultimaContagemParaSalvar = contagem; // Guarda para o bot√£o salvar
            
            // Seus c√°lculos originais
            const area = parseFloat(document.getElementById('areaInput').value) || 1;
            const kg_ha = Math.round(((contagem * 0.5) / area) * 10000);
            
            let html = `TIPO: ${file.type.startsWith("video") ? "V√çDEO" : "FOTO"}\n`;
            html += `CONTAGEM: ${contagem}\n`;
            if(file.type.startsWith("video")) {
                html += `ESTIMATIVA: ${kg_ha} KG/HA\n`;
                dadosExtrasParaSalvar = `${kg_ha} KG/HA`;
            }
            
            resultDetails.textContent = html;
            forecast.textContent = `Previs√£o de Venda: R$ ${formatterCurrency.format(kg_ha * 1.86)}`;
            
            // Habilita visualiza√ß√£o
            document.getElementById('out').innerHTML = `<button onclick="window.nav('resultado-screen')" class="btn-nova-contagem">Ver Resultado</button>`;
            
            // Gera gr√°fico (Chart.js)
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: ['Out', 'Nov', 'Dez'], datasets: [{ label: 'Pre√ßo', data: [2.5, 1.8, 1.2], borderColor: '#28a745' }] }
            });

        } catch(e) {
            statusEl.textContent = "Erro IA (Modo Demo)";
            // Fallback demo para voc√™ n√£o ficar travado
            ultimaContagemParaSalvar = 150;
            resultDetails.textContent = "DEMO: 150 Mangas Detectadas";
            document.getElementById('out').innerHTML = `<button onclick="window.nav('resultado-screen')" class="btn-nova-contagem">Ver Resultado</button>`;
        }
    };

    // --- SEU CHAT ORIGINAL (MANTIDO) ---
    const chatInput = document.getElementById('chatInput');
    const chatBtn = document.getElementById('chatSendBtn');
    const chatMsgs = document.getElementById('chatMessages');

    chatBtn.onclick = async () => {
        const txt = chatInput.value;
        if(!txt) return;
        
        // Msg User
        const divUser = document.createElement('div');
        divUser.className = 'chat-message user';
        divUser.innerHTML = `<div class="chat-message-content">${txt}</div>`;
        chatMsgs.appendChild(divUser);
        chatInput.value = "";
        
        // Webhook
        try {
            const req = await fetch("https://n8n-agent-476522137012.us-central1.run.app/webhook/chat", {
                method: "POST", headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: txt, chatId: "web_"+Date.now() })
            });
            const res = await req.json();
            const botTxt = res.output || res.message || "Recebido.";
            
            const divBot = document.createElement('div');
            divBot.className = 'chat-message bot';
            divBot.innerHTML = `<div class="chat-message-content">${marked.parse(botTxt)}</div>`;
            chatMsgs.appendChild(divBot);
        } catch(e) { console.log(e); }
    };
  </script>
</body>
</html>
